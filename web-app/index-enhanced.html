<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scraperr OSINT PWA - Advanced Interface</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <!-- JSZip para exportar ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1220;
      --panel: #020617;
      --panel-soft: #0b1220;
      --primary: #0ea5e9;
      --primary-soft: #38bdf8;
      --accent: #22c55e;
      --danger: #f97316;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --radius-xl: 22px;
      --radius: 12px;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.85);
      --font-ui: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-ui);
    }

    body {
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #020617 100%);
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      line-height: 1.5;
    }

    .frame {
      max-width: 1280px;
      margin: 0 auto;
      border-radius: 32px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(56,189,248,.4), rgba(129,140,248,.1));
      box-shadow: var(--shadow-soft);
    }

    .container {
      border-radius: 32px;
      background: radial-gradient(circle at top left, #111827 0, #020617 45%, #020617 100%);
      overflow: hidden;
    }

    header {
      padding: 20px 24px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(26px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe 0, #38bdf8 35%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      color: #0b1120;
      box-shadow: 0 8px 22px rgba(15,23,42,.9);
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: .02em;
    }

    .brand-sub {
      font-size: .8rem;
      color: var(--muted);
    }

    main {
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: var(--panel-soft);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .section-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    h2 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-soft);
    }

    .section-sub {
      font-size: .9rem;
      color: var(--muted);
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .badge {
      background: rgba(148,163,184,.12);
      border-radius: 999px;
      padding: 4px 12px;
      font-size: .85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-status {
      background: rgba(34,197,94,.15);
      color: var(--accent);
    }

    .inline-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 12px 20px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all .2s ease;
      min-height: 44px;
    }

    .btn:hover {
      background: var(--primary-soft);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: rgba(148,163,184,.18);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(148,163,184,.25);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      color: var(--text);
      font-size: 1rem;
      transition: border-color .2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      min-height: 100px;
      font-family: inherit;
      resize: vertical;
    }

    .small-help {
      font-size: .85rem;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.5;
    }

    .small-help code {
      background: rgba(0,0,0,.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }

    .response-box {
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-family: monospace;
      font-size: .9rem;
      line-height: 1.4;
      min-height: 200px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .result-preview {
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-family: monospace;
      font-size: .9rem;
      line-height: 1.4;
      min-height: 200px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(15,23,42,.95);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      color: var(--text);
      font-weight: 500;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      transform: translateX(120%);
      transition: transform .3s ease;
      z-index: 1000;
      max-width: 400px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      border-left: 4px solid var(--danger);
    }

    .notification.success {
      border-left: 4px solid var(--accent);
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .job-meta {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .platform-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin: 12px 0;
    }

    .platform-toggle {
      background: rgba(148,163,184,.12);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
    }

    .platform-toggle:hover {
      background: rgba(148,163,184,.2);
    }

    .platform-toggle.active {
      background: var(--primary);
      border-color: var(--primary-soft);
      color: white;
    }

    .config-section {
      display: none;
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: .9rem;
      border-top: 1px solid rgba(148,163,184,.18);
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="container">
      <header>
        <div class="brand">
          <div class="brand-badge">S</div>
          <div>
            <div class="brand-title">Scraperr OSINT PWA</div>
            <div class="brand-sub">Panel Apple-style para tu Scraperr API</div>
          </div>
        </div>
        <div class="brand-sub">v2.0</div>
      </header>

      <main>
        <div class="left-column">
          <!-- API Configuration Section -->
          <div class="section">
            <div class="section-header-row">
              <h2>1. API Configuration</h2>
              <span class="section-sub">Backend: <code>scraperr_api</code></span>
            </div>
            <div class="form-group">
              <label for="apiUrl">API Base URL</label>
              <input 
                id="apiUrl" 
                type="text" 
                placeholder="Ej: http://localhost:8000" 
                value="http://localhost:8000"
              />
              <div class="small-help">
                Ej: <code>http://localhost:8000</code> (scraperr_api).
              </div>
            </div>
            
            <!-- AI API Keys Configuration -->
            <div class="form-group">
              <label for="geminiKey">Google Gemini API Key</label>
              <input 
                id="geminiKey" 
                type="password" 
                placeholder="Enter your Gemini API key" 
              />
            </div>
            
            <div class="form-group">
              <label for="openaiKey">OpenAI API Key</label>
              <input 
                id="openaiKey" 
                type="password" 
                placeholder="Enter your OpenAI API key" 
              />
            </div>
            
            <button id="saveApiKeysBtn" class="btn btn-secondary">Save API Keys</button>
            
            <div class="form-group" style="margin-top: 15px;">
              <button id="toggleConfigBtn" class="btn btn-secondary">Advanced Configuration</button>
              <div id="configSection" class="config-section">
                <div class="form-group">
                  <label for="customHeaders">Custom Headers (JSON)</label>
                  <textarea id="customHeaders" placeholder="Enter custom headers as JSON">{}</textarea>
                </div>
                <div class="form-group">
                  <label for="maxItems">Max Items in Preview</label>
                  <input id="maxItems" type="number" min="1" max="100" value="10" />
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Scraping básico -->
          <div class="section">
            <div class="section-header-row">
              <h2>2. Scraping básico</h2>
              <span class="section-sub">Single job</span>
            </div>
            <div class="form-group">
              <label for="targetUrl">Target URL</label>
              <input 
                id="targetUrl" 
                type="text" 
                placeholder="Ej: https://quotes.toscrape.com/" 
                value="http://quotes.toscrape.com/"
              />
            </div>
            
            <div class="inline-group">
              <button class="btn-example" data-url="http://quotes.toscrape.com/">Quotes</button>
              <button class="btn-example" data-url="https://books.toscrape.com/">Books</button>
              <button class="btn-example" data-url="https://httpbin.org/html">HTML Test</button>
            </div>

            <div class="form-group">
              <label for="elementsSelect">Elements to Extract</label>
              <select id="elementsSelect">
                <option value="default">Default: Quotes, Books, Headings</option>
                <option value="custom">Custom (edit JSON below)</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="advancedElements">Elements personalizados (JSON)</label>
              <textarea id="advancedElements" placeholder="Formato: [{name, xpath, url}]">[
  {
    "name": "Quotes",
    "xpath": "//span[@class='text']",
    "url": "http://quotes.toscrape.com/"
  }
]</textarea>
            </div>
            
            <div class="inline-group">
              <button class="btn-example-elements" data-elements='[{"name": "Quotes", "xpath": "//span[@class=\'text\']", "url": "http://quotes.toscrape.com/"}]'>Quotes</button>
              <button class="btn-example-elements" data-elements='[{"name": "Book Names", "xpath": "//h3/a", "url": "https://books.toscrape.com/"}]'>Book Titles</button>
              <button class="btn-example-elements" data-elements='[{"name": "Headings", "xpath": "//h1|//h2|//h3", "url": "https://httpbin.org/html"}]'>Headings</button>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input id="multiPageCheckbox" type="checkbox" />
                Scraping multipágina
              </label>
            </div>

            <div class="form-group">
              <label for="deepDepthSelect">Profundidad (sugerencia para LLM)</label>
              <select id="deepDepthSelect">
                <option value="1">1 - Básico</option>
                <option value="2" selected>2 - Intermedio</option>
                <option value="3">3 - Profundo</option>
                <option value="4">4 - Extensivo</option>
              </select>
            </div>

            <div class="form-group">
              <label for="deepHint">Hint (opcional)</label>
              <input id="deepHint" type="text" placeholder="Ej: seguir links 'Siguiente', 'Next'..." />
            </div>
            <div class="small-help">
              La profundidad se envía como pista en el campo <code>prompt</code> del Job.
            </div>

            <button id="runScrapeBtn" class="btn">
              <span id="scrapeSpinner" class="loading" style="display: none;"></span>
              <span id="scrapeText">Run Scraping</span>
            </button>
          </div>

          <!-- 3. Búsqueda universal OSINT -->
          <div class="section">
            <div class="section-header-row">
              <h2>3. Búsqueda universal OSINT</h2>
              <span class="section-sub">Multi-service jobs</span>
            </div>
            <div class="form-group">
              <label for="universalQuery">Query de búsqueda</label>
              <input 
                id="universalQuery" 
                type="text" 
                placeholder="Ej: 'John Doe' OR 'j.doe@example.com'" 
              />
            </div>
            
            <div class="form-group">
              <label>Plataformas a incluir</label>
              <div class="platform-grid">
                <div class="platform-toggle" data-platform="google">Google</div>
                <div class="platform-toggle" data-platform="twitter">Twitter</div>
                <div class="platform-toggle" data-platform="facebook">Facebook</div>
                <div class="platform-toggle" data-platform="linkedin">LinkedIn</div>
                <div class="platform-toggle" data-platform="github">GitHub</div>
                <div class="platform-toggle" data-platform="instagram">Instagram</div>
                <div class="platform-toggle" data-platform="youtube">YouTube</div>
                <div class="platform-toggle" data-platform="reddit">Reddit</div>
              </div>
            </div>

            <button id="runUniversalSearchBtn" class="btn btn-secondary">
              <span id="universalSpinner" class="loading" style="display: none;"></span>
              <span id="universalText">Buscar en múltiples servicios</span>
            </button>
            <div class="small-help">
              Crea un Job por plataforma, scrapea resultados y arma una vista previa por servicio.
            </div>
          </div>
        </div>

        <div class="right-column">
          <!-- 4. Búsqueda inversa de imagen -->
          <div class="section">
            <div class="section-header-row">
              <h2>4. Búsqueda inversa de imagen</h2>
              <span class="section-sub">Scraping & preview</span>
            </div>
            <div class="form-group">
              <label for="imageUrl">URL de la imagen</label>
              <input 
                id="imageUrl" 
                type="text" 
                placeholder="Ej: https://ejemplo.com/imagen.jpg" 
              />
            </div>
            
            <div class="inline-group">
              <button class="btn-example-image" data-img="https://picsum.photos/200/300">Example 1</button>
              <button class="btn-example-image" data-img="https://picsum.photos/300/200">Example 2</button>
            </div>

            <div class="form-group">
              <label>Servicios de búsqueda</label>
              <div class="platform-grid">
                <div class="platform-toggle platform-image" data-service="google">Google Images</div>
                <div class="platform-toggle platform-image" data-service="yandex">Yandex</div>
                <div class="platform-toggle platform-image" data-service="bing">Bing Images</div>
              </div>
            </div>

            <div class="inline-group">
              <button id="runImageSearchBtn" class="btn btn-secondary">
                <span id="imageSpinner" class="loading" style="display: none;"></span>
                <span id="imageText">Buscar por imagen (scraping)</span>
              </button>
              <button id="openImageTabsBtn" class="btn">Abrir pestañas</button>
            </div>
            <div class="small-help">
              “Buscar por imagen” genera jobs sobre las páginas de resultados; “Abrir pestañas” sólo abre los buscadores con esa imagen.
            </div>
          </div>

          <!-- 5. Otros accesos -->
          <div class="section">
            <div class="section-header-row">
              <h2>5. Jobs & Docs rápidos</h2>
              <span class="section-sub">API shortcuts</span>
            </div>
            <div class="inline-group">
              <button id="listJobsBtn" class="btn btn-secondary">
                <span id="jobsSpinner" class="loading" style="display: none;"></span>
                <span id="jobsText">Ver jobs recientes</span>
              </button>
              <button id="openDocsBtn" class="btn btn-secondary">Abrir Swagger /docs</button>
            </div>
            
            <div class="inline-group" style="margin-top: 10px;">
              <button id="exportZipBtn" class="btn">Exportar resultados ZIP</button>
              <button id="clearResultsBtn" class="btn btn-secondary">Limpiar resultados</button>
            </div>
          </div>

          <!-- Estado / respuesta -->
          <div class="section">
            <div class="section-header-row">
              <h2>Estado / respuesta</h2>
              <span class="section-sub">Job actual / OSINT multi-servicio</span>
            </div>
            <div class="tag-row">
              <span class="badge badge-status" id="statusBadge">Idle</span>
              <span class="badge">Vista previa limitada a <span id="badgeMaxItems">10</span> ítems</span>
            </div>
            <div class="job-meta" id="jobMeta">
              Todavía no se envió ningún job.
            </div>
            <div class="response-box" id="jobResponse">
              Esperando que envíes un scraping o búsqueda OSINT.
            </div>
          </div>

          <!-- Vista previa / resumen -->
          <div class="section">
            <div class="section-header-row">
              <h2>Vista previa / resumen</h2>
              <span class="section-sub">Recorte de datos para inspección rápida</span>
            </div>
            <div class="result-preview" id="resultPreview">
              Cuando el job termine, verás acá un resumen estructurado.
            </div>
          </div>
        </div>
      </main>

      <div id="notification" class="notification"></div>

      <footer>
        <span>Scraperr OSINT PWA • Cliente avanzado sobre tu backend <code>scraperr_api</code></span>
      </footer>
    </div>
  </div>

  <script>
    // Elements
    const apiUrlInput = document.getElementById("apiUrl");
    const targetUrlInput = document.getElementById("targetUrl");
    const elementsSelect = document.getElementById("elementsSelect");
    const advancedElements = document.getElementById("advancedElements");
    const multiPageCheckbox = document.getElementById("multiPageCheckbox");
    const deepDepthSelect = document.getElementById("deepDepthSelect");
    const deepHintInput = document.getElementById("deepHint");
    const runScrapeBtn = document.getElementById("runScrapeBtn");
    const universalQueryInput = document.getElementById("universalQuery");
    const runUniversalSearchBtn = document.getElementById("runUniversalSearchBtn");
    const imageUrlInput = document.getElementById("imageUrl");
    const runImageSearchBtn = document.getElementById("runImageSearchBtn");
    const openImageTabsBtn = document.getElementById("openImageTabsBtn");
    const listJobsBtn = document.getElementById("listJobsBtn");
    const openDocsBtn = document.getElementById("openDocsBtn");
    const notificationEl = document.getElementById("notification");
    const jobMetaEl = document.getElementById("jobMeta");
    const jobResponseEl = document.getElementById("jobResponse");
    const resultPreviewEl = document.getElementById("resultPreview");
    const statusBadge = document.getElementById("statusBadge");
    const badgeMaxItems = document.getElementById("badgeMaxItems");
    const exportZipBtn = document.getElementById("exportZipBtn");
    const clearResultsBtn = document.getElementById("clearResultsBtn");
    const maxItemsInput = document.getElementById("maxItems");
    
    // AI API Key elements
    const geminiKeyInput = document.getElementById("geminiKey");
    const openaiKeyInput = document.getElementById("openaiKey");
    const saveApiKeysBtn = document.getElementById("saveApiKeysBtn");
    const toggleConfigBtn = document.getElementById("toggleConfigBtn");
    const configSection = document.getElementById("configSection");
    
    // Platform toggles
    const platformToggles = document.querySelectorAll(".platform-toggle:not(.platform-image)");
    const imageToggles = document.querySelectorAll(".platform-toggle.platform-image");
    
    // Spinner elements
    const scrapeSpinner = document.getElementById("scrapeSpinner");
    const scrapeText = document.getElementById("scrapeText");
    const universalSpinner = document.getElementById("universalSpinner");
    const universalText = document.getElementById("universalText");
    const imageSpinner = document.getElementById("imageSpinner");
    const imageText = document.getElementById("imageText");
    const jobsSpinner = document.getElementById("jobsSpinner");
    const jobsText = document.getElementById("jobsText");
    
    // Variables de estado
    let lastRawResults = null;
    let lastPreviewData = null;
    let selectedPlatforms = [];
    let selectedImageServices = [];

    // Inicialización
    document.addEventListener("DOMContentLoaded", () => {
      // Cargar configuración desde localStorage
      const savedUrl = localStorage.getItem("scraperr_api_url");
      if (savedUrl) apiUrlInput.value = savedUrl;
      
      const savedMaxItems = localStorage.getItem("scraperr_max_items");
      if (savedMaxItems) {
        maxItemsInput.value = savedMaxItems;
        badgeMaxItems.textContent = savedMaxItems;
      }
      
      const savedGeminiKey = localStorage.getItem("gemini_api_key");
      if (savedGeminiKey) geminiKeyInput.value = savedGeminiKey;
      
      const savedOpenaiKey = localStorage.getItem("openai_api_key");
      if (savedOpenaiKey) openaiKeyInput.value = savedOpenaiKey;

      // Event listeners para guardar configuración
      apiUrlInput.addEventListener("change", () => {
        localStorage.setItem("scraperr_api_url", apiUrlInput.value);
      });
      
      maxItemsInput.addEventListener("change", () => {
        localStorage.setItem("scraperr_max_items", maxItemsInput.value);
        badgeMaxItems.textContent = maxItemsInput.value;
      });

      // Event listeners para toggles de plataforma
      platformToggles.forEach(toggle => {
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const platform = toggle.getAttribute("data-platform");
          
          if (toggle.classList.contains("active")) {
            if (!selectedPlatforms.includes(platform)) {
              selectedPlatforms.push(platform);
            }
          } else {
            selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
          }
        });
      });
      
      imageToggles.forEach(toggle => {
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const service = toggle.getAttribute("data-service");
          
          if (toggle.classList.contains("active")) {
            if (!selectedImageServices.includes(service)) {
              selectedImageServices.push(service);
            }
          } else {
            selectedImageServices = selectedImageServices.filter(s => s !== service);
          }
        });
      });

      // Event listeners para botones de ejemplo
      document.querySelectorAll(".btn-example").forEach(btn => {
        btn.addEventListener("click", () => {
          targetUrlInput.value = btn.getAttribute("data-url");
        });
      });
      
      document.querySelectorAll(".btn-example-elements").forEach(btn => {
        btn.addEventListener("click", () => {
          advancedElements.value = btn.getAttribute("data-elements");
        });
      });
      
      document.querySelectorAll(".btn-example-image").forEach(btn => {
        btn.addEventListener("click", () => {
          imageUrlInput.value = btn.getAttribute("data-img");
        });
      });
    });

    // Función para mostrar notificaciones
    function showNotification(text, isError = false) {
      notificationEl.textContent = text;
      notificationEl.className = "notification";
      if (isError) {
        notificationEl.classList.add("error");
      } else {
        notificationEl.classList.add("success");
      }
      notificationEl.classList.add("show");
      
      setTimeout(() => {
        notificationEl.classList.remove("show");
      }, 5000);
    }

    // Función para actualizar estado
    function setStatus(status) {
      statusBadge.textContent = status;
      statusBadge.className = "badge badge-status";
      if (status.includes("…")) {
        statusBadge.classList.add("working");
      } else if (status.toLowerCase().includes("error") || status.toLowerCase().includes("fail")) {
        statusBadge.classList.add("error");
      } else if (status.toLowerCase() === "idle" || status.toLowerCase() === "completed") {
        statusBadge.classList.add("success");
      }
    }

    // Llamada genérica a API
    async function callApi(path, method = "GET", body = null) {
      const url = localStorage.getItem("scraperr_api_url") || apiUrlInput.value.trim();
      if (!url) {
        showNotification("Configura primero la API Base URL", true);
        throw new Error("API URL vacía");
      }
      
      const fullUrl = url.endsWith("/") ? url + path.replace(/^\//, "") : url + path;
      
      const options = {
        method,
        headers: { "Content-Type": "application/json" }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(fullUrl, options);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API error ${response.status}: ${errorText}`);
      }
      
      return { data: await response.json(), response };
    }

    // Función para construir elementos de scraping
    function buildElementsFromSelection() {
      if (elementsSelect.value === "custom") {
        try {
          return JSON.parse(advancedElements.value);
        } catch (e) {
          showNotification("JSON de elementos inválido: " + e.message, true);
          throw e;
        }
      }
      
      // Elementos por defecto según la URL
      const url = targetUrlInput.value.toLowerCase();
      if (url.includes("quotes.toscrape.com")) {
        return [
          { name: "Quotes", xpath: "//span[@class='text']", url: targetUrlInput.value },
          { name: "Authors", xpath: "//small[@class='author']", url: targetUrlInput.value },
          { name: "Tags", xpath: "//div[@class='tags']/a", url: targetUrlInput.value }
        ];
      } else if (url.includes("books.toscrape.com")) {
        return [
          { name: "Titles", xpath: "//h3/a", url: targetUrlInput.value },
          { name: "Prices", xpath: "//p[@class='price_color']", url: targetUrlInput.value },
          { name: "Ratings", xpath: "//p[contains(@class, 'star-rating')]/@class", url: targetUrlInput.value }
        ];
      } else {
        return [
          { name: "Headings", xpath: "//h1|//h2|//h3", url: targetUrlInput.value },
          { name: "Links", xpath: "//a/@href", url: targetUrlInput.value },
          { name: "Images", xpath: "//img/@src", url: targetUrlInput.value }
        ];
      }
    }

    // Función para construir opciones del job
    function buildJobOptions() {
      return {
        multi_page_scrape: multiPageCheckbox.checked,
        custom_headers: {},
        proxies: [],
        site_map: null,
        collect_media: false,
        return_html: false,
        custom_cookies: []
      };
    }

    // Esperar a que un job termine
    async function waitForJobCompletion(jobId, maxWaitMs = 35000, intervalMs = 3000) {
      const start = Date.now();
      let lastData = null;

      while (Date.now() - start < maxWaitMs) {
        const { data } = await callApi(`/api/job/${encodeURIComponent(jobId)}`, "GET");
        lastData = data;

        const status = (data.status || data.Status || "").toString();
        jobMetaEl.textContent = `Job ${jobId} – Estado: ${status}`;
        jobResponseEl.textContent = JSON.stringify(data, null, 2);
        setStatus(status || "Unknown");

        if (status.toLowerCase() === "completed" || status.toLowerCase() === "failed") {
          return data;
        }

        await new Promise(resolve => setTimeout(resolve, intervalMs));
      }

      throw new Error(`Job ${jobId} no terminó después de ${maxWaitMs}ms`);
    }

    // Scraping directo con spinner
    runScrapeBtn.addEventListener("click", async () => {
      try {
        // Toggle the spinner
        scrapeSpinner.style.display = "inline-block";
        scrapeText.textContent = "Working...";
        showNotification("Enviando job de scraping...");
        setStatus("Working…");

        const url = targetUrlInput.value.trim();
        if (!url) {
          showNotification("La URL objetivo no puede estar vacía", true);
          setStatus("Error");
          return;
        }

        const elements = buildElementsFromSelection();
        const jobOptions = buildJobOptions();
        const depth = deepDepthSelect.value;
        const hint = deepHintInput.value.trim();

        const jobBody = {
          url,
          elements,
          job_options: jobOptions,
          prompt: `Profundidad deseada: ${depth}. Hint: ${hint || "sin hint"}`,
        };

        const submit = await callApi("/api/submit-scrape-job", "POST", jobBody);
        jobResponseEl.textContent = JSON.stringify(submit.data, null, 2);

        if (!submit.data || !submit.data.id) {
          showNotification("Job enviado, pero sin ID en la respuesta.", true);
          setStatus("Error");
          return;
        }

        const jobId = submit.data.id;
        jobMetaEl.textContent = `Job enviado. ID: ${jobId}. Esperando resultado...`;
        showNotification(`Job ${jobId} enviado; consultando estado...`);

        const jobData = await waitForJobCompletion(jobId);
        const maxItems = maxItemsInput.value || "10";

        const preview = sliceResultForPreview(jobData?.result || jobData?.Result || jobData, maxItems);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = jobData;
        lastPreviewData = preview;

        showNotification("Job completado. Mirá la vista previa y, si querés, exportá el ZIP.");
        
        // Reset the spinner
        scrapeSpinner.style.display = "none";
        scrapeText.textContent = "Run Scraping";
      } catch (e) {
        showNotification(e.message, true);
        setStatus("Error");
        // Reset the spinner
        scrapeSpinner.style.display = "none";
        scrapeText.textContent = "Run Scraping";
      }
    });

    // Búsqueda OSINT multi-servicio
    runUniversalSearchBtn.addEventListener("click", async () => {
      try {
        universalSpinner.style.display = "inline-block";
        universalText.textContent = "Buscando...";
        showNotification("Generando y enviando jobs OSINT...");
        setStatus("OSINT…");

        if (selectedPlatforms.length === 0) {
          showNotification("Seleccioná al menos una plataforma.", true);
          setStatus("Error");
          return;
        }

        const query = universalQueryInput.value.trim();
        if (!query) {
          showNotification("La query no puede estar vacía", true);
          setStatus("Error");
          return;
        }

        const UNIVERSAL_SEARCH_URLS = {
          google: (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
          twitter: (q) => `https://twitter.com/search?q=${encodeURIComponent(q)}`,
          facebook: (q) => `https://www.facebook.com/search/top/?q=${encodeURIComponent(q)}`,
          linkedin: (q) => `https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(q)}`,
          github: (q) => `https://github.com/search?q=${encodeURIComponent(q)}`,
          instagram: (q) => `https://www.instagram.com/explore/tags/${encodeURIComponent(q.replace(/\s+/g, ''))}/`,
          youtube: (q) => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
          reddit: (q) => `https://www.reddit.com/search/?q=${encodeURIComponent(q)}`
        };

        const jobs = [];
        for (const platform of selectedPlatforms) {
          if (UNIVERSAL_SEARCH_URLS[platform]) {
            const url = UNIVERSAL_SEARCH_URLS[platform](query);
            const job = {
              url,
              elements: [
                { name: "Links", xpath: "//a/@href", url: null },
                { name: "Titles", xpath: "//title", url: null },
                { name: "Text", xpath: "//body//text()", url: null },
              ],
              job_options: {
                multi_page_scrape: false,
                collect_media: false,
                custom_headers: {},
                proxies: [],
                custom_cookies: [],
                site_map: null,
                return_html: false,
              },
              prompt: `OSINT para query="${query}" en plataforma=${platform}`,
            };

            const response = await callApi("/api/submit-scrape-job", "POST", job);
            if (response.data.id) {
              jobs.push({ platform, jobId: response.data.id });
            }
          }
        }

        const results = {};
        for (const job of jobs) {
          const data = await waitForJobCompletion(job.jobId);
          results[job.platform] = data.result || data;
        }

        // Preview para resultados OSINT
        const preview = {};
        const maxItems = maxItemsInput.value || "10";
        for (const [platform, data] of Object.entries(results)) {
          const result = Array.isArray(data) ? data : (data?.result || data);
          const links = extractFromResult(result, "Links");
          const titles = extractFromResult(result, "Titles");
          const text = extractFromResult(result, "Text");
          
          preview[platform] = {
            title: titles?.[0] || "",
            first_links: (links || []).slice(0, maxItems),
            first_text: (text || []).slice(0, maxItems),
          };
        }

        jobMetaEl.textContent = "Resultados OSINT multi-plataforma (respuesta completa abajo).";
        jobResponseEl.textContent = JSON.stringify(results, null, 2);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = results;
        lastPreviewData = preview;

        showNotification("Búsqueda OSINT completada. Ver resultados y vista previa.");
        
        universalSpinner.style.display = "none";
        universalText.textContent = "Buscar en múltiples servicios";
      } catch (e) {
        showNotification(e.message, true);
        setStatus("Error");
        universalSpinner.style.display = "none";
        universalText.textContent = "Buscar en múltiples servicios";
      }
    });

    // Función para extraer datos de resultados
    function extractFromResult(result, fieldName) {
      if (!result) return [];
      if (Array.isArray(result)) {
        // Si es un array de objetos como [{name, data}, ...]
        const fieldObj = result.find(obj => obj.name === fieldName);
        if (fieldObj && fieldObj.data) {
          return Array.isArray(fieldObj.data) ? fieldObj.data : [fieldObj.data];
        } else {
          // Si es un array plano
          return result;
        }
      } else if (result[fieldName]) {
        return Array.isArray(result[fieldName]) ? result[fieldName] : [result[fieldName]];
      } else if (result.Result && result.Result[fieldName]) {
        return Array.isArray(result.Result[fieldName]) ? result.Result[fieldName] : [result.Result[fieldName]];
      }
      return [];
    }

    // Recorte para vista previa
    function sliceResultForPreview(data, maxItems) {
      if (!data) return data;

      if (Array.isArray(data)) {
        // Si es un array de objetos como [{name, data}, ...]
        return data.map(obj => {
          if (obj.name && obj.data && Array.isArray(obj.data)) {
            return {
              name: obj.name,
              data: obj.data.slice(0, maxItems)
            };
          }
          return obj;
        });
      } else if (typeof data === "object") {
        // Si es un objeto con múltiples campos
        const result = {};
        for (const [key, value] of Object.entries(data)) {
          if (Array.isArray(value)) {
            result[key] = value.slice(0, maxItems);
          } else {
            result[key] = value;
          }
        }
        return result;
      }
      return data;
    }

    // Búsqueda inversa por imagen
    async function runImageSearch(shouldScrape = true) {
      try {
        imageSpinner.style.display = "inline-block";
        imageText.textContent = "Buscando...";
        
        const imgUrl = imageUrlInput.value.trim();
        if (!imgUrl) {
          showNotification("La URL de la imagen no puede estar vacía", true);
          return;
        }

        if (!shouldScrape) {
          // Sólo abrir pestañas
          if (selectedImageServices.length === 0) {
            selectedImageServices = ["google", "yandex", "bing"]; // Default
          }
          
          const IMAGE_SEARCH_URLS = {
            google: (img) => `https://lens.google.com/uploadbyurl?url=${encodeURIComponent(img)}`,
            yandex: (img) => `https://yandex.com/images/search?url=${encodeURIComponent(img)}&rpt=imageview`,
            bing: (img) => `https://www.bing.com/images/search?view=detailv2&iss=sbi&q=imgurl:${encodeURIComponent(img)}`
          };

          for (const service of selectedImageServices) {
            if (IMAGE_SEARCH_URLS[service]) {
              window.open(IMAGE_SEARCH_URLS[service](imgUrl), '_blank');
            }
          }
          showNotification("Abrí pestañas con los buscadores de imágenes.");
          imageSpinner.style.display = "none";
          imageText.textContent = "Buscar por imagen (scraping)";
          return;
        }

        // Scraping
        showNotification("Enviando jobs de búsqueda inversa...");
        setStatus("Img OSINT…");

        if (selectedImageServices.length === 0) {
          selectedImageServices = ["google", "yandex", "bing"]; // Default
        }

        const IMAGE_SEARCH_URLS = {
          google: (img) => `https://lens.google.com/uploadbyurl?url=${encodeURIComponent(img)}`,
          yandex: (img) => `https://yandex.com/images/search?url=${encodeURIComponent(img)}&rpt=imageview`,
          bing: (img) => `https://www.bing.com/images/search?view=detailv2&iss=sbi&q=imgurl:${encodeURIComponent(img)}`
        };

        const jobs = [];
        for (const t of selectedImageServices) {
          const url = IMAGE_SEARCH_URLS[t](imgUrl);
          const job = {
            url,
            elements: [
              { name: "Links", xpath: "//a/@href", url: null },
              { name: "Titles", xpath: "//title", url: null },
              { name: "Text", xpath: "//body//text()", url: null },
            ],
            job_options: {
              multi_page_scrape: false,
              collect_media: false,
              custom_headers: {},
              proxies: [],
              custom_cookies: [],
              site_map: null,
              return_html: false,
            },
            prompt: `OSINT por imagen URL=${imgUrl} en servicio=${t}`,
          };
          const resp = await callApi("/api/submit-scrape-job", "POST", job);
          if (resp.data.id) jobs.push({ service: t, jobId: resp.data.id });
        }

        const results = {};
        for (const job of jobs) {
          const data = await waitForJobCompletion(job.jobId);
          results[job.service] = data.result || data;
        }

        const preview = {};
        const maxItems = maxItemsInput.value || "10";
        for (const [service, data] of Object.entries(results)) {
          const result = Array.isArray(data) ? data : (data?.result || data);
          const links = extractFromResult(result, "Links");
          const titles = extractFromResult(result, "Titles");
          
          preview[service] = {
            title: titles?.[0] || "",
            first_links: (links || []).slice(0, maxItems),
          };
        }

        jobMetaEl.textContent = "Resultados de búsqueda inversa por imagen.";
        jobResponseEl.textContent = JSON.stringify(results, null, 2);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = results;
        lastPreviewData = preview;

        showNotification("Búsqueda inversa completada.");
        imageSpinner.style.display = "none";
        imageText.textContent = "Buscar por imagen (scraping)";
      } catch (e) {
        showNotification(e.message, true);
        setStatus("Error");
        imageSpinner.style.display = "none";
        imageText.textContent = "Buscar por imagen (scraping)";
      }
    }

    runImageSearchBtn.addEventListener("click", () => runImageSearch(true));
    openImageTabsBtn.addEventListener("click", () => runImageSearch(false));

    // Jobs recientes
    listJobsBtn.addEventListener("click", async () => {
      try {
        jobsSpinner.style.display = "inline-block";
        jobsText.textContent = "Cargando...";
        const { data } = await callApi("/api/retrieve-scrape-jobs", "POST", { chat: null });
        jobMetaEl.textContent = "Jobs recientes (respuesta cruda de la API):";
        jobResponseEl.textContent = JSON.stringify(data, null, 2);
        showNotification("Jobs recuperados.");
        jobsSpinner.style.display = "none";
        jobsText.textContent = "Ver jobs recientes";
      } catch (e) {
        showNotification(e.message, true);
        jobsSpinner.style.display = "none";
        jobsText.textContent = "Ver jobs recientes";
      }
    });

    // Abrir docs
    openDocsBtn.addEventListener("click", () => {
      const url = localStorage.getItem("scraperr_api_url") || apiUrlInput.value.trim();
      if (url) {
        window.open(url + "/docs", "_blank");
      } else {
        showNotification("Configura la API Base URL primero", true);
      }
    });

    // Exportar ZIP
    exportZipBtn.addEventListener("click", async () => {
      if (!lastRawResults) {
        showNotification("No hay resultados para exportar", true);
        return;
      }

      try {
        const zip = new JSZip();
        zip.file("results.json", JSON.stringify(lastRawResults, null, 2));
        zip.file("preview.json", JSON.stringify(lastPreviewData, null, 2));

        const content = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "scraperr_results.zip";
        a.click();
        
        showNotification("Archivo ZIP descargado");
      } catch (e) {
        showNotification("Error al generar el ZIP: " + e.message, true);
      }
    });

    // Limpiar resultados
    clearResultsBtn.addEventListener("click", () => {
      jobResponseEl.textContent = "Esperando que envíes un scraping o búsqueda OSINT.";
      resultPreviewEl.textContent = "Cuando el job termine, verás acá un resumen estructurado.";
      jobMetaEl.textContent = "Todavía no se envió ningún job.";
      lastRawResults = null;
      lastPreviewData = null;
      showNotification("Resultados limpiados");
    });

    // AI API Key Functions
    saveApiKeysBtn.addEventListener("click", () => {
      if (geminiKeyInput.value) {
        localStorage.setItem("gemini_api_key", geminiKeyInput.value);
        showNotification("Gemini API key saved");
      }
      if (openaiKeyInput.value) {
        localStorage.setItem("openai_api_key", openaiKeyInput.value);
        showNotification("OpenAI API key saved");
      }
    });
    
    toggleConfigBtn.addEventListener("click", () => {
      configSection.style.display = configSection.style.display === "block" ? "none" : "block";
    });
  </script>
</body>
</html>