<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scraperr OSINT PWA - Enhanced Interface with Logs</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <!-- JSZip para exportar ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1220;
      --panel: #020617;
      --panel-soft: #0b1220;
      --primary: #0ea5e9;
      --primary-soft: #38bdf8;
      --accent: #22c55e;
      --danger: #f97316;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --radius-xl: 22px;
      --radius: 12px;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.85);
      --font-ui: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-ui);
    }

    body {
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #020617 100%);
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      line-height: 1.5;
    }

    .frame {
      max-width: 1400px;
      margin: 0 auto;
      border-radius: 32px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(56,189,248,.4), rgba(129,140,248,.1));
      box-shadow: var(--shadow-soft);
    }

    .container {
      border-radius: 32px;
      background: radial-gradient(circle at top left, #111827 0, #020617 45%, #020617 100%);
      overflow: hidden;
    }

    header {
      padding: 20px 24px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(26px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe 0, #38bdf8 35%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      color: #0b1120;
      box-shadow: 0 8px 22px rgba(15,23,42,.9);
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: .02em;
    }

    .brand-sub {
      font-size: .8rem;
      color: var(--muted);
    }

    main {
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: var(--panel-soft);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .section-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    h2 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-soft);
    }

    .section-sub {
      font-size: .9rem;
      color: var(--muted);
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .badge {
      background: rgba(148,163,184,.12);
      border-radius: 999px;
      padding: 4px 12px;
      font-size: .85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-status {
      background: rgba(34,197,94,.15);
      color: var(--accent);
    }

    .inline-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 12px 20px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all .2s ease;
      min-height: 44px;
    }

    .btn:hover {
      background: var(--primary-soft);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: rgba(148,163,184,.18);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(148,163,184,.25);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      color: var(--text);
      font-size: 1rem;
      transition: border-color .2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      min-height: 100px;
      font-family: inherit;
      resize: vertical;
    }

    .small-help {
      font-size: .85rem;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.5;
    }

    .small-help code {
      background: rgba(0,0,0,.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }

    .response-box {
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-family: monospace;
      font-size: .9rem;
      line-height: 1.4;
      min-height: 200px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .result-preview {
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-family: monospace;
      font-size: .9rem;
      line-height: 1.4;
      min-height: 200px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(15,23,42,.95);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      color: var(--text);
      font-weight: 500;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      transform: translateX(120%);
      transition: transform .3s ease;
      z-index: 1000;
      max-width: 400px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      border-left: 4px solid var(--danger);
    }

    .notification.success {
      border-left: 4px solid var(--accent);
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .job-meta {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .platform-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin: 12px 0;
    }

    .platform-toggle {
      background: rgba(148,163,184,.12);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
    }

    .platform-toggle:hover {
      background: rgba(148,163,184,.2);
    }

    .platform-toggle.active {
      background: var(--primary);
      border-color: var(--primary-soft);
      color: white;
    }

    .config-section {
      display: none;
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
    }

    .content-type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin: 12px 0;
    }

    .content-type-toggle {
      background: rgba(148,163,184,.12);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
      font-size: 0.85rem;
    }

    .content-type-toggle:hover {
      background: rgba(148,163,184,.2);
    }

    .content-type-toggle.active {
      background: var(--primary);
      border-color: var(--primary-soft);
      color: white;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: .9rem;
      border-top: 1px solid rgba(148,163,184,.18);
    }
    
    /* Log panel styles */
    .log-panel {
      background: rgba(15,23,42,.35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: .9rem;
      line-height: 1.4;
    }
    
    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid rgba(148,163,184,.1);
      display: flex;
      align-items: flex-start;
    }
    
    .log-icon {
      font-size: 1.2rem;
      margin-right: 10px;
      min-width: 24px;
      text-align: center;
    }
    
    .log-timestamp {
      color: var(--muted);
      font-size: .8rem;
      margin-bottom: 2px;
    }
    
    .log-message {
      flex: 1;
    }
    
    .log-level-info { color: var(--primary-soft); }
    .log-level-success { color: var(--accent); }
    .log-level-warning { color: var(--danger); }
    .log-level-error { color: #ef4444; }
    
    .progress-bar {
      height: 8px;
      background: rgba(148,163,184,.2);
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .status-card {
      display: flex;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background: rgba(15,23,42,.35);
      border-radius: var(--radius);
      border-left: 4px solid var(--primary);
    }
    
    .status-icon {
      font-size: 1.5rem;
      margin-right: 10px;
    }
    
    .status-info {
      flex: 1;
    }
    
    .status-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .status-desc {
      font-size: .9rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="container">
      <header>
        <div class="brand">
          <div class="brand-badge">S</div>
          <div>
            <div class="brand-title">Scraperr OSINT PWA</div>
            <div class="brand-sub">Panel Apple-style para tu Scraperr API</div>
          </div>
        </div>
        <div class="brand-sub">v4.0 - Con Logs</div>
      </header>

      <main>
        <div class="left-column">
          <!-- API Configuration Section -->
          <div class="section">
            <div class="section-header-row">
              <h2>1. API Configuration</h2>
              <span class="section-sub">Backend: <code>scraperr_api</code></span>
            </div>
            <div class="form-group">
              <label for="apiUrl">API Base URL</label>
              <input 
                id="apiUrl" 
                type="text" 
                placeholder="Ej: http://localhost:8000" 
                value="http://localhost:8000"
              />
              <div class="small-help">
                Ej: <code>http://localhost:8000</code> (scraperr_api).
              </div>
            </div>
            
            <!-- AI API Keys Configuration -->
            <div class="form-group">
              <label for="geminiKey">Google Gemini API Key</label>
              <input 
                id="geminiKey" 
                type="password" 
                placeholder="Enter your Gemini API key" 
              />
            </div>
            
            <div class="form-group">
              <label for="openaiKey">OpenAI API Key</label>
              <input 
                id="openaiKey" 
                type="password" 
                placeholder="Enter your OpenAI API key" 
              />
            </div>
            
            <button id="saveApiKeysBtn" class="btn btn-secondary">Save API Keys</button>
            
            <div class="form-group" style="margin-top: 15px;">
              <button id="toggleConfigBtn" class="btn btn-secondary">Advanced Configuration</button>
              <div id="configSection" class="config-section">
                <div class="form-group">
                  <label for="customHeaders">Custom Headers (JSON)</label>
                  <textarea id="customHeaders" placeholder="Enter custom headers as JSON">{}</textarea>
                </div>
                <div class="form-group">
                  <label for="maxItems">Max Items in Preview</label>
                  <input id="maxItems" type="number" min="1" max="100" value="10" />
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Scraping b√°sico -->
          <div class="section">
            <div class="section-header-row">
              <h2>2. Scraping b√°sico</h2>
              <span class="section-sub">Single job</span>
            </div>
            <div class="form-group">
              <label for="targetUrl">Target URL</label>
              <input 
                id="targetUrl" 
                type="text" 
                placeholder="Ej: https://quotes.toscrape.com/" 
                value="http://quotes.toscrape.com/"
              />
            </div>
            
            <div class="inline-group">
              <button class="btn-example" data-url="http://quotes.toscrape.com/">Quotes</button>
              <button class="btn-example" data-url="https://books.toscrape.com/">Books</button>
              <button class="btn-example" data-url="https://httpbin.org/html">HTML Test</button>
            </div>

            <div class="form-group">
              <label>Tipos de contenido a descargar</label>
              <div class="content-type-grid">
                <div class="content-type-toggle active" data-type="text">Texto</div>
                <div class="content-type-toggle active" data-type="images">Im√°genes</div>
                <div class="content-type-toggle" data-type="videos">V√≠deos</div>
                <div class="content-type-toggle" data-type="links">Enlaces</div>
                <div class="content-type-toggle" data-type="documents">Documentos</div>
                <div class="content-type-toggle" data-type="audio">Audio</div>
              </div>
            </div>

            <div class="form-group">
              <label for="elementsSelect">Elements to Extract</label>
              <select id="elementsSelect">
                <option value="default">Default: Quotes, Books, Headings</option>
                <option value="custom">Custom (edit JSON below)</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="advancedElements">Elements personalizados (JSON)</label>
              <textarea id="advancedElements" placeholder="Formato: [{name, xpath, url}]">[
  {
    "name": "Quotes",
    "xpath": "//span[@class='text']",
    "url": "http://quotes.toscrape.com/"
  }
]</textarea>
            </div>
            
            <div class="inline-group">
              <button class="btn-example-elements" data-elements='[{"name": "Quotes", "xpath": "//span[@class=\'text\']", "url": "http://quotes.toscrape.com/"}]'>Quotes</button>
              <button class="btn-example-elements" data-elements='[{"name": "Book Names", "xpath": "//h3/a", "url": "https://books.toscrape.com/"}]'>Book Titles</button>
              <button class="btn-example-elements" data-elements='[{"name": "Headings", "xpath": "//h1|//h2|//h3", "url": "https://httpbin.org/html"}]'>Headings</button>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input id="multiPageCheckbox" type="checkbox" />
                Scraping multip√°gina
              </label>
            </div>

            <div class="form-group">
              <label for="deepDepthSelect">Profundidad (sugerencia para LLM)</label>
              <select id="deepDepthSelect">
                <option value="1">1 - B√°sico</option>
                <option value="2" selected>2 - Intermedio</option>
                <option value="3">3 - Profundo</option>
                <option value="4">4 - Extensivo</option>
              </select>
            </div>

            <div class="form-group">
              <label for="deepHint">Hint (opcional)</label>
              <input id="deepHint" type="text" placeholder="Ej: seguir links 'Siguiente', 'Next'..." />
            </div>
            <div class="small-help">
              La profundidad se env√≠a como pista en el campo <code>prompt</code> del Job.
            </div>

            <button id="runScrapeBtn" class="btn">
              <span id="scrapeSpinner" class="loading" style="display: none;"></span>
              <span id="scrapeText">Run Scraping</span>
            </button>
          </div>

          <!-- 3. B√∫squeda universal OSINT -->
          <div class="section">
            <div class="section-header-row">
              <h2>3. B√∫squeda universal OSINT</h2>
              <span class="section-sub">Multi-service jobs</span>
            </div>
            <div class="form-group">
              <label for="universalQuery">Query de b√∫squeda</label>
              <input 
                id="universalQuery" 
                type="text" 
                placeholder="Ej: 'John Doe' OR 'j.doe@example.com'" 
              />
            </div>
            
            <div class="form-group">
              <label>Plataformas a incluir</label>
              <div class="platform-grid">
                <div class="platform-toggle" data-platform="google">Google</div>
                <div class="platform-toggle" data-platform="twitter">Twitter</div>
                <div class="platform-toggle" data-platform="facebook">Facebook</div>
                <div class="platform-toggle" data-platform="linkedin">LinkedIn</div>
                <div class="platform-toggle" data-platform="github">GitHub</div>
                <div class="platform-toggle" data-platform="instagram">Instagram</div>
                <div class="platform-toggle" data-platform="youtube">YouTube</div>
                <div class="platform-toggle" data-platform="reddit">Reddit</div>
              </div>
            </div>

            <button id="runUniversalSearchBtn" class="btn btn-secondary">
              <span id="universalSpinner" class="loading" style="display: none;"></span>
              <span id="universalText">Buscar en m√∫ltiples servicios</span>
            </button>
            <div class="small-help">
              Crea un Job por plataforma, scrapea resultados y arma una vista previa por servicio.
            </div>
          </div>
        </div>

        <div class="right-column">
          <!-- 4. B√∫squeda inversa de imagen -->
          <div class="section">
            <div class="section-header-row">
              <h2>4. B√∫squeda inversa de imagen</h2>
              <span class="section-sub">Scraping & preview</span>
            </div>
            <div class="form-group">
              <label for="imageUrl">URL de la imagen</label>
              <input 
                id="imageUrl" 
                type="text" 
                placeholder="Ej: https://ejemplo.com/imagen.jpg" 
              />
            </div>
            
            <div class="inline-group">
              <button class="btn-example-image" data-img="https://picsum.photos/200/300">Example 1</button>
              <button class="btn-example-image" data-img="https://picsum.photos/300/200">Example 2</button>
            </div>

            <div class="form-group">
              <label>Servicios de b√∫squeda</label>
              <div class="platform-grid">
                <div class="platform-toggle platform-image" data-service="google">Google Images</div>
                <div class="platform-toggle platform-image" data-service="yandex">Yandex</div>
                <div class="platform-toggle platform-image" data-service="bing">Bing Images</div>
              </div>
            </div>

            <div class="inline-group">
              <button id="runImageSearchBtn" class="btn btn-secondary">
                <span id="imageSpinner" class="loading" style="display: none;"></span>
                <span id="imageText">Buscar por imagen (scraping)</span>
              </button>
              <button id="openImageTabsBtn" class="btn">Abrir pesta√±as</button>
            </div>
            <div class="small-help">
              ‚ÄúBuscar por imagen‚Äù genera jobs sobre las p√°ginas de resultados; ‚ÄúAbrir pesta√±as‚Äù s√≥lo abre los buscadores con esa imagen.
            </div>
          </div>

          <!-- Content Type Filters -->
          <div class="section">
            <div class="section-header-row">
              <h2>Filtros de Contenido</h2>
              <span class="section-sub">Tipos de contenido a descargar</span>
            </div>
            
            <div class="content-type-grid">
              <div class="content-type-toggle active" data-type="text">Texto</div>
              <div class="content-type-toggle active" data-type="images">Im√°genes</div>
              <div class="content-type-toggle" data-type="videos">V√≠deos</div>
              <div class="content-type-toggle" data-type="links">Enlaces</div>
              <div class="content-type-toggle" data-type="documents">Documentos</div>
              <div class="content-type-toggle" data-type="audio">Audio</div>
            </div>
            
            <div style="margin-top: 15px;">
              <button id="selectAllContentBtn" class="btn btn-secondary">Seleccionar Todo</button>
              <button id="clearAllContentBtn" class="btn btn-secondary">Limpiar Todo</button>
            </div>
          </div>

          <!-- 5. Otros accesos -->
          <div class="section">
            <div class="section-header-row">
              <h2>5. Jobs & Docs r√°pidos</h2>
              <span class="section-sub">API shortcuts</span>
            </div>
            <div class="inline-group">
              <button id="listJobsBtn" class="btn btn-secondary">
                <span id="jobsSpinner" class="loading" style="display: none;"></span>
                <span id="jobsText">Ver jobs recientes</span>
              </button>
              <button id="openDocsBtn" class="btn btn-secondary">Abrir Swagger /docs</button>
            </div>
            
            <div class="inline-group" style="margin-top: 10px;">
              <button id="exportZipBtn" class="btn">Exportar resultados ZIP</button>
              <button id="clearResultsBtn" class="btn btn-secondary">Limpiar resultados</button>
            </div>
          </div>
          
          <!-- Status Indicators -->
          <div class="section">
            <div class="section-header-row">
              <h2>Estado del Sistema</h2>
              <span class="section-sub">Indicadores de actividad</span>
            </div>
            
            <div class="status-card">
              <div class="status-icon">üì°</div>
              <div class="status-info">
                <div class="status-title">Conexi√≥n API</div>
                <div class="status-desc">Conectado a http://localhost:8000</div>
              </div>
              <div class="badge badge-status" id="connectionStatus">Conectado</div>
            </div>
            
            <div class="status-card">
              <div class="status-icon">üîÑ</div>
              <div class="status-info">
                <div class="status-title">√öltima acci√≥n</div>
                <div class="status-desc" id="lastAction">Ninguna acci√≥n reciente</div>
              </div>
            </div>
            
            <div class="status-card">
              <div class="status-icon">üìä</div>
              <div class="status-info">
                <div class="status-title">Progreso Operaci√≥n</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="operationProgress" style="width: 0%"></div>
                </div>
                <div id="progressText">No hay operaci√≥n en curso</div>
              </div>
            </div>
          </div>

          <!-- Estado / respuesta -->
          <div class="section">
            <div class="section-header-row">
              <h2>Estado / respuesta</h2>
              <span class="section-sub">Job actual / OSINT multi-servicio</span>
            </div>
            <div class="tag-row">
              <span class="badge badge-status" id="statusBadge">Idle</span>
              <span class="badge">Vista previa limitada a <span id="badgeMaxItems">10</span> √≠tems</span>
            </div>
            <div class="job-meta" id="jobMeta">
              Todav√≠a no se envi√≥ ning√∫n job.
            </div>
            <div class="response-box" id="jobResponse">
              Esperando que env√≠es un scraping o b√∫squeda OSINT.
            </div>
          </div>

          <!-- Vista previa / resumen -->
          <div class="section">
            <div class="section-header-row">
              <h2>Vista previa / resumen</h2>
              <span class="section-sub">Recorte de datos para inspecci√≥n r√°pida</span>
            </div>
            <div class="result-preview" id="resultPreview">
              Cuando el job termine, ver√°s ac√° un resumen estructurado.
            </div>
          </div>
        </div>
        
        <!-- Log Panel -->
        <div class="section" style="grid-column: 1 / -1; margin-top: -15px;">
          <div class="section-header-row">
            <h2>üìã Panel de Logs - Sistema de Scraping</h2>
            <span class="section-sub">Registros detallados de actividades</span>
          </div>
          
          <div class="log-panel" id="logPanel">
            <div class="log-entry">
              <div class="log-icon">‚úÖ</div>
              <div class="log-message">
                <div class="log-timestamp">2025-11-13 02:15:30</div>
                <div class="log-level-success">Aplicaci√≥n inicializada correctamente</div>
                <div class="log-desc">Scraperr OSINT PWA v4.0 cargado y listo para usar</div>
              </div>
            </div>
            
            <div class="log-entry">
              <div class="log-icon">üì°</div>
              <div class="log-message">
                <div class="log-timestamp">2025-11-13 02:15:32</div>
                <div class="log-level-info">Conexi√≥n API establecida</div>
                <div class="log-desc">Conectado a http://localhost:8000</div>
              </div>
            </div>
            
            <div class="log-entry">
              <div class="log-icon">‚öôÔ∏è</div>
              <div class="log-message">
                <div class="log-timestamp">2025-11-13 02:15:35</div>
                <div class="log-level-info">Configuraci√≥n cargada</div>
                <div class="log-desc">Par√°metros de scraping configurados correctamente</div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button id="clearLogsBtn" class="btn btn-secondary">Limpiar Logs</button>
            <button id="downloadLogsBtn" class="btn btn-secondary">Descargar Logs</button>
            <button id="toggleLogDetailsBtn" class="btn btn-secondary">Mostrar/Ocultar Detalles</button>
          </div>
        </div>
      </main>

      <div id="notification" class="notification"></div>

      <footer>
        <span>Scraperr OSINT PWA ‚Ä¢ Cliente avanzado sobre tu backend <code>scraperr_api</code></span>
      </footer>
    </div>
  </div>

  <script>
    // Elements
    const apiUrlInput = document.getElementById("apiUrl");
    const targetUrlInput = document.getElementById("targetUrl");
    const elementsSelect = document.getElementById("elementsSelect");
    const advancedElements = document.getElementById("advancedElements");
    const multiPageCheckbox = document.getElementById("multiPageCheckbox");
    const deepDepthSelect = document.getElementById("deepDepthSelect");
    const deepHintInput = document.getElementById("deepHint");
    const runScrapeBtn = document.getElementById("runScrapeBtn");
    const universalQueryInput = document.getElementById("universalQuery");
    const runUniversalSearchBtn = document.getElementById("runUniversalSearchBtn");
    const imageUrlInput = document.getElementById("imageUrl");
    const runImageSearchBtn = document.getElementById("runImageSearchBtn");
    const openImageTabsBtn = document.getElementById("openImageTabsBtn");
    const listJobsBtn = document.getElementById("listJobsBtn");
    const openDocsBtn = document.getElementById("openDocsBtn");
    const notificationEl = document.getElementById("notification");
    const jobMetaEl = document.getElementById("jobMeta");
    const jobResponseEl = document.getElementById("jobResponse");
    const resultPreviewEl = document.getElementById("resultPreview");
    const statusBadge = document.getElementById("statusBadge");
    const badgeMaxItems = document.getElementById("badgeMaxItems");
    const exportZipBtn = document.getElementById("exportZipBtn");
    const clearResultsBtn = document.getElementById("clearResultsBtn");
    const maxItemsInput = document.getElementById("maxItems");
    
    // AI API Key elements
    const geminiKeyInput = document.getElementById("geminiKey");
    const openaiKeyInput = document.getElementById("openaiKey");
    const saveApiKeysBtn = document.getElementById("saveApiKeysBtn");
    const toggleConfigBtn = document.getElementById("toggleConfigBtn");
    const configSection = document.getElementById("configSection");
    
    // Content type elements
    const contentTypeToggles = document.querySelectorAll(".content-type-toggle");
    const selectAllContentBtn = document.getElementById("selectAllContentBtn");
    const clearAllContentBtn = document.getElementById("clearAllContentBtn");
    
    // Platform toggles
    const platformToggles = document.querySelectorAll(".platform-toggle:not(.platform-image)");
    const imageToggles = document.querySelectorAll(".platform-toggle.platform-image");
    
    // Spinner elements
    const scrapeSpinner = document.getElementById("scrapeSpinner");
    const scrapeText = document.getElementById("scrapeText");
    const universalSpinner = document.getElementById("universalSpinner");
    const universalText = document.getElementById("universalText");
    const imageSpinner = document.getElementById("imageSpinner");
    const imageText = document.getElementById("imageText");
    const jobsSpinner = document.getElementById("jobsSpinner");
    const jobsText = document.getElementById("jobsText");
    
    // Log panel elements
    const logPanel = document.getElementById("logPanel");
    const clearLogsBtn = document.getElementById("clearLogsBtn");
    const downloadLogsBtn = document.getElementById("downloadLogsBtn");
    const toggleLogDetailsBtn = document.getElementById("toggleLogDetailsBtn");
    
    // Status elements
    const connectionStatus = document.getElementById("connectionStatus");
    const lastAction = document.getElementById("lastAction");
    const operationProgress = document.getElementById("operationProgress");
    const progressText = document.getElementById("progressText");
    
    // Variables de estado
    let lastRawResults = null;
    let lastPreviewData = null;
    let selectedPlatforms = [];
    let selectedImageServices = [];
    let selectedContentTypes = ['text', 'images']; // Default selections
    let isScraping = false;

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      // Cargar configuraci√≥n desde localStorage
      const savedUrl = localStorage.getItem("scraperr_api_url");
      if (savedUrl) apiUrlInput.value = savedUrl;
      
      const savedMaxItems = localStorage.getItem("scraperr_max_items");
      if (savedMaxItems) {
        maxItemsInput.value = savedMaxItems;
        badgeMaxItems.textContent = savedMaxItems;
      }
      
      const savedGeminiKey = localStorage.getItem("gemini_api_key");
      if (savedGeminiKey) geminiKeyInput.value = savedGeminiKey;
      
      const savedOpenaiKey = localStorage.getItem("openai_api_key");
      if (savedOpenaiKey) openaiKeyInput.value = savedOpenaiKey;

      // Event listeners para guardar configuraci√≥n
      apiUrlInput.addEventListener("change", () => {
        localStorage.setItem("scraperr_api_url", apiUrlInput.value);
        addLog("üì°", "Conexi√≥n API actualizada", `Nueva URL: ${apiUrlInput.value}`, "info");
      });
      
      maxItemsInput.addEventListener("change", () => {
        localStorage.setItem("scraperr_max_items", maxItemsInput.value);
        badgeMaxItems.textContent = maxItemsInput.value;
        addLog("‚öôÔ∏è", "L√≠mite de elementos actualizado", `Nuevo l√≠mite: ${maxItemsInput.value}`, "info");
      });

      // Event listeners para toggles de plataforma
      platformToggles.forEach(toggle => {
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const platform = toggle.getAttribute("data-platform");
          
          if (toggle.classList.contains("active")) {
            if (!selectedPlatforms.includes(platform)) {
              selectedPlatforms.push(platform);
              addLog("üîÑ", "Plataforma a√±adida", `B√∫squeda en ${platform}`, "info");
            }
          } else {
            selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
            addLog("üîÑ", "Plataforma removida", `B√∫squeda en ${platform} desactivada`, "info");
          }
        });
      });
      
      imageToggles.forEach(toggle => {
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const service = toggle.getAttribute("data-service");
          
          if (toggle.classList.contains("active")) {
            if (!selectedImageServices.includes(service)) {
              selectedImageServices.push(service);
              addLog("üñºÔ∏è", "Servicio de imagen a√±adido", `B√∫squeda en ${service}`, "info");
            }
          } else {
            selectedImageServices = selectedImageServices.filter(s => s !== service);
            addLog("üñºÔ∏è", "Servicio de imagen removido", `B√∫squeda en ${service} desactivada`, "info");
          }
        });
      });

      // Content type toggles
      contentTypeToggles.forEach(toggle => {
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const type = toggle.getAttribute("data-type");
          
          if (toggle.classList.contains("active")) {
            if (!selectedContentTypes.includes(type)) {
              selectedContentTypes.push(type);
              addLog("üìã", "Tipo de contenido a√±adido", `Descargando ${type}`, "info");
            }
          } else {
            selectedContentTypes = selectedContentTypes.filter(t => t !== type);
            addLog("üìã", "Tipo de contenido removido", `Dejando de descargar ${type}`, "info");
          }
        });
      });

      // Event listeners para botones de ejemplo
      document.querySelectorAll(".btn-example").forEach(btn => {
        btn.addEventListener("click", () => {
          targetUrlInput.value = btn.getAttribute("data-url");
          addLog("üîó", "URL actualizada", `Nueva URL: ${targetUrlInput.value}`, "info");
        });
      });
      
      document.querySelectorAll(".btn-example-elements").forEach(btn => {
        btn.addEventListener("click", () => {
          advancedElements.value = btn.getAttribute("data-elements");
          addLog("üìù", "Elementos actualizados", "Nuevos elementos de scraping configurados", "info");
        });
      });
      
      document.querySelectorAll(".btn-example-image").forEach(btn => {
        btn.addEventListener("click", () => {
          imageUrlInput.value = btn.getAttribute("data-img");
          addLog("üñºÔ∏è", "Imagen actualizada", `Nueva imagen: ${imageUrlInput.value}`, "info");
        });
      });
      
      // Content type buttons
      selectAllContentBtn.addEventListener("click", () => {
        contentTypeToggles.forEach(toggle => {
          toggle.classList.add("active");
          const type = toggle.getAttribute("data-type");
          if (!selectedContentTypes.includes(type)) {
            selectedContentTypes.push(type);
          }
        });
        addLog("üìã", "Todos los tipos seleccionados", "Descargando todo tipo de contenido", "success");
      });
      
      clearAllContentBtn.addEventListener("click", () => {
        contentTypeToggles.forEach(toggle => {
          toggle.classList.remove("active");
        });
        selectedContentTypes = [];
        addLog("üìã", "Tipos de contenido limpiados", "No se descargar√° ning√∫n tipo de contenido", "warning");
      });
      
      // Log panel buttons
      clearLogsBtn.addEventListener("click", () => {
        logPanel.innerHTML = '';
        addLog("üßπ", "Logs limpiados", "Historial de actividades eliminado", "info");
      });
      
      downloadLogsBtn.addEventListener("click", () => {
        const logContent = Array.from(logPanel.children).map(entry => {
          const timestamp = entry.querySelector('.log-timestamp').textContent;
          const level = entry.querySelector('.log-level-success, .log-level-info, .log-level-warning, .log-level-error').textContent;
          const desc = entry.querySelector('.log-desc').textContent;
          return `[${timestamp}] ${level} - ${desc}`;
        }).join('\n');
        
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scraperr-logs.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog("üì•", "Logs descargados", "Archivo de logs guardado correctamente", "success");
      });
      
      toggleLogDetailsBtn.addEventListener("click", () => {
        document.querySelectorAll('.log-desc').forEach(desc => {
          desc.style.display = desc.style.display === 'none' ? 'block' : 'none';
        });
        addLog("üëÅÔ∏è", "Detalles de logs", `Detalles ${document.querySelectorAll('.log-desc[style="display: none;"]').length ? 'mostrados' : 'ocultos'}`, "info");
      });
    });

    // Funci√≥n para agregar un log al panel
    function addLog(icon, title, description, level = 'info') {
      const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      logEntry.innerHTML = `
        <div class="log-icon">${icon}</div>
        <div class="log-message">
          <div class="log-timestamp">${timestamp}</div>
          <div class="log-level-${level}">${title}</div>
          <div class="log-desc">${description}</div>
        </div>
      `;
      
      logPanel.insertBefore(logEntry, logPanel.firstChild);
      
      // Mantener solo los √∫ltimos 50 registros
      if (logPanel.children.length > 50) {
        logPanel.removeChild(logPanel.lastChild);
      }
      
      // Hacer scroll al nuevo log
      logPanel.scrollTop = 0;
    }

    // Funci√≥n para mostrar notificaciones
    function showNotification(text, isError = false) {
      notificationEl.textContent = text;
      notificationEl.className = "notification";
      if (isError) {
        notificationEl.classList.add("error");
      } else {
        notificationEl.classList.add("success");
      }
      notificationEl.classList.add("show");
      
      setTimeout(() => {
        notificationEl.classList.remove("show");
      }, 5000);
    }

    // Funci√≥n para actualizar estado
    function setStatus(status) {
      statusBadge.textContent = status;
      statusBadge.className = "badge badge-status";
      if (status.includes("‚Ä¶")) {
        statusBadge.classList.add("working");
      } else if (status.toLowerCase().includes("error") || status.toLowerCase().includes("fail")) {
        statusBadge.classList.add("error");
      } else if (status.toLowerCase() === "idle" || status.toLowerCase() === "completed") {
        statusBadge.classList.add("success");
      }
    }

    // Llamada gen√©rica a API
    async function callApi(path, method = "GET", body = null) {
      const url = localStorage.getItem("scraperr_api_url") || apiUrlInput.value.trim();
      if (!url) {
        showNotification("Configura primero la API Base URL", true);
        throw new Error("API URL vac√≠a");
      }
      
      const fullUrl = url.endsWith("/") ? url + path.replace(/^\//, "") : url + path;
      
      const options = {
        method,
        headers: { "Content-Type": "application/json" }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      let response;
      try {
        response = await fetch(fullUrl, options);
      } catch (networkError) {
        addLog("‚ùå", "Error de red", `No se pudo conectar a la API: ${networkError.message}`, "error");
        showNotification(`Error de red: ${networkError.message}`, true);
        throw new Error(`Error de red: ${networkError.message}`);
      }
      
      if (!response.ok) {
        const errorText = await response.text();
        addLog("‚ùå", "Error de API", `C√≥digo: ${response.status}, Mensaje: ${errorText}`, "error");
        
        // Check if it's an authentication error
        if (response.status === 401 || response.status === 403) {
          showNotification("Error de autenticaci√≥n. Verifica tu configuraci√≥n.", true);
        } else {
          showNotification(`API error ${response.status}: ${errorText}`, true);
        }
        throw new Error(`API error ${response.status}: ${errorText}`);
      }
      
      return { data: await response.json(), response };
    }

    // Funci√≥n para construir elementos de scraping
    function buildElementsFromSelection() {
      if (elementsSelect.value === "custom") {
        try {
          return JSON.parse(advancedElements.value);
        } catch (e) {
          addLog("‚ùå", "Error en elementos JSON", e.message, "error");
          showNotification("JSON de elementos inv√°lido: " + e.message, true);
          throw e;
        }
      }
      
      // Elementos por defecto seg√∫n la URL y tipos de contenido seleccionados
      const url = targetUrlInput.value.toLowerCase();
      const elements = [];
      
      if (selectedContentTypes.includes('text')) {
        if (url.includes("quotes.toscrape.com")) {
          elements.push(
            { name: "Quotes", xpath: "//span[@class='text']", url: targetUrlInput.value },
            { name: "Authors", xpath: "//small[@class='author']", url: targetUrlInput.value }
          );
          addLog("üìù", "Elementos de texto detectados", "Identificados citas y autores", "info");
        } else if (url.includes("books.toscrape.com")) {
          elements.push(
            { name: "Titles", xpath: "//h3/a", url: targetUrlInput.value },
            { name: "Prices", xpath: "//p[@class='price_color']", url: targetUrlInput.value }
          );
          addLog("üìù", "Elementos de texto detectados", "Identificados t√≠tulos y precios", "info");
        } else {
          elements.push(
            { name: "Headings", xpath: "//h1|//h2|//h3", url: targetUrlInput.value },
            { name: "Paragraphs", xpath: "//p", url: targetUrlInput.value }
          );
          addLog("üìù", "Elementos de texto detectados", "Detectados encabezados y p√°rrafos", "info");
        }
      }
      
      if (selectedContentTypes.includes('images')) {
        elements.push({ name: "Images", xpath: "//img/@src", url: targetUrlInput.value });
        addLog("üñºÔ∏è", "Elementos de im√°genes detectados", "Configurado scraping de im√°genes", "info");
      }
      
      if (selectedContentTypes.includes('links')) {
        elements.push({ name: "Links", xpath: "//a/@href", url: targetUrlInput.value });
        addLog("üîó", "Elementos de enlaces detectados", "Configurado scraping de enlaces", "info");
      }
      
      if (selectedContentTypes.includes('videos')) {
        elements.push({ name: "Videos", xpath: "//video/@src | //iframe/@src", url: targetUrlInput.value });
        addLog("üìπ", "Elementos de video detectados", "Configurado scraping de videos", "info");
      }
      
      if (selectedContentTypes.includes('documents')) {
        elements.push({ name: "Documents", xpath: "//a[contains(@href, '.pdf') or contains(@href, '.doc') or contains(@href, '.docx')]/@href", url: targetUrlInput.value });
        addLog("üìÑ", "Elementos de documentos detectados", "Configurado scraping de documentos", "info");
      }
      
      if (selectedContentTypes.includes('audio')) {
        elements.push({ name: "Audio", xpath: "//audio/@src", url: targetUrlInput.value });
        addLog("üéµ", "Elementos de audio detectados", "Configurado scraping de audio", "info");
      }
      
      return elements;
    }

    // Funci√≥n para construir opciones del job
    function buildJobOptions() {
      return {
        multi_page_scrape: multiPageCheckbox.checked,
        custom_headers: {},
        proxies: [],
        site_map: null,
        collect_media: selectedContentTypes.includes('images') || selectedContentTypes.includes('videos') || selectedContentTypes.includes('audio'),
        return_html: false,
        custom_cookies: []
      };
    }

    // Esperar a que un job termine
    async function waitForJobCompletion(jobId, maxWaitMs = 35000, intervalMs = 3000) {
      const start = Date.now();
      let lastData = null;
      let progress = 0;
      
      // Actualizar barra de progreso
      progressText.textContent = `Job ${jobId} en progreso...`;
      
      while (Date.now() - start < maxWaitMs) {
        try {
          const { data } = await callApi(`/api/job/${encodeURIComponent(jobId)}`, "GET");
          lastData = data;

          const status = (data.status || data.Status || data.state || "").toString();
          jobMetaEl.textContent = `Job ${jobId} ‚Äì Estado: ${status}`;
          jobResponseEl.textContent = JSON.stringify(data, null, 2);
          setStatus(status || "Unknown");
          
          // Actualizar barra de progreso basado en el estado
          if (status.toLowerCase() === "completed") {
            progress = 100;
          } else if (status.toLowerCase() === "processing" || status.toLowerCase() === "running") {
            progress = 60;
          } else if (status.toLowerCase() === "submitted") {
            progress = 20;
          } else {
            progress = 40;
          }
          
          operationProgress.style.width = `${progress}%`;
          
          if (status.toLowerCase() === "completed" || status.toLowerCase() === "failed" || status.toLowerCase() === "error") {
            operationProgress.style.width = '100%';
            progressText.textContent = `Job ${jobId} finalizado (${status.toLowerCase()})`;
            setTimeout(() => {
              operationProgress.style.width = '0%';
              progressText.textContent = 'No hay operaci√≥n en curso';
            }, 3000);
            
            return data;
          }
        } catch (error) {
          console.error("Error getting job status:", error);
          jobMetaEl.textContent = `Job ${jobId} ‚Äì Error retrieving status: ${error.message}`;
          setStatus("Error");
          
          operationProgress.style.width = '0%';
          progressText.textContent = 'Error al obtener estado del job';
          throw error;
        }

        await new Promise(resolve => setTimeout(resolve, intervalMs));
      }

      operationProgress.style.width = '0%';
      progressText.textContent = 'Tiempo de espera excedido';
      throw new Error(`Job ${jobId} no termin√≥ despu√©s de ${maxWaitMs}ms`);
    }

    // Scraping directo con spinner
    runScrapeBtn.addEventListener("click", async () => {
      isScraping = true;
      try {
        // Toggle the spinner
        scrapeSpinner.style.display = "inline-block";
        scrapeText.textContent = "Working...";
        showNotification("Enviando job de scraping...");
        setStatus("Working‚Ä¶");
        lastAction.textContent = "Iniciando scraping";
        
        addLog("üöÄ", "Iniciando scraping", `URL objetivo: ${targetUrlInput.value}`, "info");
        addLog("üìã", "Tipos de contenido", `Seleccionados: ${selectedContentTypes.join(', ')}`, "info");

        const url = targetUrlInput.value.trim();
        if (!url) {
          addLog("‚ùå", "URL vac√≠a", "No se proporcion√≥ URL para scraping", "error");
          showNotification("La URL objetivo no puede estar vac√≠a", true);
          setStatus("Error");
          return;
        }

        const elements = buildElementsFromSelection();
        const jobOptions = buildJobOptions();
        const depth = deepDepthSelect.value;
        const hint = deepHintInput.value.trim();

        const jobBody = {
          url,
          elements,
          job_options: jobOptions,
          prompt: `Profundidad deseada: ${depth}. Tipos de contenido: ${selectedContentTypes.join(', ')}. Hint: ${hint || "sin hint"}`,
        };

        addLog("üì§", "Enviando job", "Petici√≥n enviada a la API", "info");
        const submit = await callApi("/api/submit-scrape-job", "POST", jobBody);
        jobResponseEl.textContent = JSON.stringify(submit.data, null, 2);

        if (!submit.data || !submit.data.id) {
          addLog("‚ùå", "Job sin ID", "La API no devolvi√≥ un ID de job", "error");
          showNotification("Job enviado, pero sin ID en la respuesta.", true);
          setStatus("Error");
          return;
        }

        const jobId = submit.data.id;
        addLog("‚úÖ", "Job enviado", `ID: ${jobId}`, "success");
        jobMetaEl.textContent = `Job enviado. ID: ${jobId}. Esperando resultado...`;
        showNotification(`Job ${jobId} enviado; consultando estado...`);

        const jobData = await waitForJobCompletion(jobId);
        const maxItems = maxItemsInput.value || "10";

        const preview = sliceResultForPreview(jobData?.result || jobData?.Result || jobData, maxItems);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = jobData;
        lastPreviewData = preview;

        showNotification("Job completado. Mir√° la vista previa y, si quer√©s, export√° el ZIP.");
        lastAction.textContent = `Scraping completado (Job: ${jobId})`;
        
        // Reset the spinner
        scrapeSpinner.style.display = "none";
        scrapeText.textContent = "Run Scraping";
      } catch (e) {
        addLog("‚ùå", "Error en scraping", e.message, "error");
        showNotification(e.message, true);
        setStatus("Error");
        lastAction.textContent = `Error en scraping: ${e.message}`;
        // Reset the spinner
        scrapeSpinner.style.display = "none";
        scrapeText.textContent = "Run Scraping";
      } finally {
        isScraping = false;
      }
    });

    // B√∫squeda OSINT multi-servicio
    runUniversalSearchBtn.addEventListener("click", async () => {
      isScraping = true;
      try {
        universalSpinner.style.display = "inline-block";
        universalText.textContent = "Buscando...";
        showNotification("Generando y enviando jobs OSINT...");
        setStatus("OSINT‚Ä¶");
        lastAction.textContent = "Iniciando b√∫squeda OSINT";

        addLog("üîç", "Iniciando OSINT", `B√∫squeda para: ${universalQueryInput.value}`, "info");
        addLog("üîÑ", "Plataformas seleccionadas", `${selectedPlatforms.join(', ')}`, "info");

        if (selectedPlatforms.length === 0) {
          addLog("‚ùå", "No hay plataformas", "Selecciona al menos una plataforma", "error");
          showNotification("Seleccion√° al menos una plataforma.", true);
          setStatus("Error");
          return;
        }

        const query = universalQueryInput.value.trim();
        if (!query) {
          addLog("‚ùå", "Consulta vac√≠a", "No se proporcion√≥ consulta", "error");
          showNotification("La query no puede estar vac√≠a", true);
          setStatus("Error");
          return;
        }

        const UNIVERSAL_SEARCH_URLS = {
          google: (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
          twitter: (q) => `https://twitter.com/search?q=${encodeURIComponent(q)}`,
          facebook: (q) => `https://www.facebook.com/search/top/?q=${encodeURIComponent(q)}`,
          linkedin: (q) => `https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(q)}`,
          github: (q) => `https://github.com/search?q=${encodeURIComponent(q)}`,
          instagram: (q) => `https://www.instagram.com/explore/tags/${encodeURIComponent(q.replace(/\s+/g, ''))}/`,
          youtube: (q) => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
          reddit: (q) => `https://www.reddit.com/search/?q=${encodeURIComponent(q)}`
        };

        const jobs = [];
        for (const platform of selectedPlatforms) {
          if (UNIVERSAL_SEARCH_URLS[platform]) {
            const url = UNIVERSAL_SEARCH_URLS[platform](query);
            addLog("üì§", "Enviando job", `${platform}: ${url}`, "info");
            
            const job = {
              url,
              elements: [
                { name: "Links", xpath: "//a/@href", url: null },
                { name: "Titles", xpath: "//title", url: null },
                { name: "Text", xpath: "//body//text()", url: null },
              ],
              job_options: {
                multi_page_scrape: false,
                collect_media: false,
                custom_headers: {},
                proxies: [],
                custom_cookies: [],
                site_map: null,
                return_html: false,
              },
              prompt: `OSINT para query="${query}" en plataforma=${platform}`,
            };

            const response = await callApi("/api/submit-scrape-job", "POST", job);
            if (response.data.id) {
              jobs.push({ platform, jobId: response.data.id });
              addLog("‚úÖ", "Job creado", `${platform} (ID: ${response.data.id})`, "success");
            }
          }
        }

        const results = {};
        for (const job of jobs) {
          addLog("‚è≥", "Esperando job", `Plataforma: ${job.platform}`, "info");
          const data = await waitForJobCompletion(job.jobId);
          results[job.platform] = data.result || data;
        }

        // Preview para resultados OSINT
        const preview = {};
        const maxItems = maxItemsInput.value || "10";
        for (const [platform, data] of Object.entries(results)) {
          const result = Array.isArray(data) ? data : (data?.result || data);
          const links = extractFromResult(result, "Links");
          const titles = extractFromResult(result, "Titles");
          const text = extractFromResult(result, "Text");
          
          preview[platform] = {
            title: titles?.[0] || "",
            first_links: (links || []).slice(0, maxItems),
            first_text: (text || []).slice(0, maxItems),
          };
        }

        jobMetaEl.textContent = "Resultados OSINT multi-plataforma (respuesta completa abajo).";
        jobResponseEl.textContent = JSON.stringify(results, null, 2);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = results;
        lastPreviewData = preview;

        showNotification("B√∫squeda OSINT completada. Ver resultados y vista previa.");
        lastAction.textContent = `B√∫squeda OSINT completada (${selectedPlatforms.length} plataformas)`;
        
        universalSpinner.style.display = "none";
        universalText.textContent = "Buscar en m√∫ltiples servicios";
      } catch (e) {
        addLog("‚ùå", "Error en OSINT", e.message, "error");
        showNotification(e.message, true);
        setStatus("Error");
        lastAction.textContent = `Error en OSINT: ${e.message}`;
        universalSpinner.style.display = "none";
        universalText.textContent = "Buscar en m√∫ltiples servicios";
      } finally {
        isScraping = false;
      }
    });

    // Funci√≥n para extraer datos de resultados
    function extractFromResult(result, fieldName) {
      if (!result) return [];
      if (Array.isArray(result)) {
        // Si es un array de objetos como [{name, data}, ...]
        const fieldObj = result.find(obj => obj.name === fieldName);
        if (fieldObj && fieldObj.data) {
          return Array.isArray(fieldObj.data) ? fieldObj.data : [fieldObj.data];
        } else {
          // Si es un array plano
          return result;
        }
      } else if (result[fieldName]) {
        return Array.isArray(result[fieldName]) ? result[fieldName] : [result[fieldName]];
      } else if (result.Result && result.Result[fieldName]) {
        return Array.isArray(result.Result[fieldName]) ? result.Result[fieldName] : [result.Result[fieldName]];
      }
      return [];
    }

    // Recorte para vista previa
    function sliceResultForPreview(data, maxItems) {
      if (!data) return data;

      if (Array.isArray(data)) {
        // Si es un array de objetos como [{name, data}, ...]
        return data.map(obj => {
          if (obj.name && obj.data && Array.isArray(obj.data)) {
            return {
              name: obj.name,
              data: obj.data.slice(0, maxItems)
            };
          }
          return obj;
        });
      } else if (typeof data === "object") {
        // Si es un objeto con m√∫ltiples campos
        const result = {};
        for (const [key, value] of Object.entries(data)) {
          if (Array.isArray(value)) {
            result[key] = value.slice(0, maxItems);
          } else {
            result[key] = value;
          }
        }
        return result;
      }
      return data;
    }

    // B√∫squeda inversa por imagen
    async function runImageSearch(shouldScrape = true) {
      isScraping = true;
      try {
        imageSpinner.style.display = "inline-block";
        imageText.textContent = "Buscando...";
        
        const imgUrl = imageUrlInput.value.trim();
        if (!imgUrl) {
          addLog("‚ùå", "Imagen vac√≠a", "No se proporcion√≥ URL de imagen", "error");
          showNotification("La URL de la imagen no puede estar vac√≠a", true);
          return;
        }

        addLog("üñºÔ∏è", "B√∫squeda de imagen", `Imagen: ${imgUrl}`, "info");

        if (!shouldScrape) {
          // S√≥lo abrir pesta√±as
          if (selectedImageServices.length === 0) {
            selectedImageServices = ["google", "yandex", "bing"]; // Default
            addLog("üîÑ", "Servicios por defecto", "Usando Google, Yandex y Bing", "info");
          }
          
          const IMAGE_SEARCH_URLS = {
            google: (img) => `https://lens.google.com/uploadbyurl?url=${encodeURIComponent(img)}`,
            yandex: (img) => `https://yandex.com/images/search?url=${encodeURIComponent(img)}&rpt=imageview`,
            bing: (img) => `https://www.bing.com/images/search?view=detailv2&iss=sbi&q=imgurl:${encodeURIComponent(img)}`
          };

          for (const service of selectedImageServices) {
            if (IMAGE_SEARCH_URLS[service]) {
              window.open(IMAGE_SEARCH_URLS[service](imgUrl), '_blank');
              addLog("üåê", "Pesta√±a abierta", `Servicio: ${service}`, "info");
            }
          }
          showNotification("Abr√≠ pesta√±as con los buscadores de im√°genes.");
          lastAction.textContent = "Pesta√±as de b√∫squeda de imagen abiertas";
          imageSpinner.style.display = "none";
          imageText.textContent = "Buscar por imagen (scraping)";
          return;
        }

        // Scraping
        showNotification("Enviando jobs de b√∫squeda inversa...");
        setStatus("Img OSINT‚Ä¶");
        lastAction.textContent = "Iniciando b√∫squeda inversa de imagen";

        if (selectedImageServices.length === 0) {
          selectedImageServices = ["google", "yandex", "bing"]; // Default
          addLog("üîÑ", "Servicios por defecto", "Usando Google, Yandex y Bing", "info");
        }

        const IMAGE_SEARCH_URLS = {
          google: (img) => `https://lens.google.com/uploadbyurl?url=${encodeURIComponent(img)}`,
          yandex: (img) => `https://yandex.com/images/search?url=${encodeURIComponent(img)}&rpt=imageview`,
          bing: (img) => `https://www.bing.com/images/search?view=detailv2&iss=sbi&q=imgurl:${encodeURIComponent(img)}`
        };

        const jobs = [];
        for (const t of selectedImageServices) {
          const url = IMAGE_SEARCH_URLS[t](imgUrl);
          addLog("üì§", "Enviando job imagen", `${t}: ${url}`, "info");
          
          const job = {
            url,
            elements: [
              { name: "Links", xpath: "//a/@href", url: null },
              { name: "Titles", xpath: "//title", url: null },
              { name: "Text", xpath: "//body//text()", url: null },
            ],
            job_options: {
              multi_page_scrape: false,
              collect_media: false,
              custom_headers: {},
              proxies: [],
              custom_cookies: [],
              site_map: null,
              return_html: false,
            },
            prompt: `OSINT por imagen URL=${imgUrl} en servicio=${t}`,
          };
          const resp = await callApi("/api/submit-scrape-job", "POST", job);
          if (resp.data.id) jobs.push({ service: t, jobId: resp.data.id });
        }

        const results = {};
        for (const job of jobs) {
          addLog("‚è≥", "Esperando job imagen", `Servicio: ${job.service}`, "info");
          const data = await waitForJobCompletion(job.jobId);
          results[job.service] = data.result || data;
        }

        const preview = {};
        const maxItems = maxItemsInput.value || "10";
        for (const [service, data] of Object.entries(results)) {
          const result = Array.isArray(data) ? data : (data?.result || data);
          const links = extractFromResult(result, "Links");
          const titles = extractFromResult(result, "Titles");
          
          preview[service] = {
            title: titles?.[0] || "",
            first_links: (links || []).slice(0, maxItems),
          };
        }

        jobMetaEl.textContent = "Resultados de b√∫squeda inversa por imagen.";
        jobResponseEl.textContent = JSON.stringify(results, null, 2);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = results;
        lastPreviewData = preview;

        showNotification("B√∫squeda inversa completada.");
        lastAction.textContent = `B√∫squeda inversa completada (${selectedImageServices.length} servicios)`;
        imageSpinner.style.display = "none";
        imageText.textContent = "Buscar por imagen (scraping)";
      } catch (e) {
        addLog("‚ùå", "Error en b√∫squeda imagen", e.message, "error");
        showNotification(e.message, true);
        setStatus("Error");
        lastAction.textContent = `Error en b√∫squeda imagen: ${e.message}`;
        imageSpinner.style.display = "none";
        imageText.textContent = "Buscar por imagen (scraping)";
      } finally {
        isScraping = false;
      }
    }

    runImageSearchBtn.addEventListener("click", () => runImageSearch(true));
    openImageTabsBtn.addEventListener("click", () => runImageSearch(false));

    // Jobs recientes
    listJobsBtn.addEventListener("click", async () => {
      try {
        jobsSpinner.style.display = "inline-block";
        jobsText.textContent = "Cargando...";
        addLog("üìã", "Recuperando jobs", "Solicitando lista de jobs recientes", "info");
        
        const { data } = await callApi("/api/retrieve-scrape-jobs", "POST", { chat: null });
        jobMetaEl.textContent = "Jobs recientes (respuesta cruda de la API):";
        jobResponseEl.textContent = JSON.stringify(data, null, 2);
        showNotification("Jobs recuperados.");
        
        // A√±adir logs para cada job recuperado
        if (data && Array.isArray(data) && data.length > 0) {
          addLog("‚úÖ", "Jobs recuperados", `${data.length} jobs encontrados`, "success");
          data.slice(0, 3).forEach(job => {
            addLog("üìã", "Job encontrado", `${job.id || job.JobId || job.job_id} - ${job.status || job.Status}`, "info");
          });
        } else {
          addLog("‚ö†Ô∏è", "No hay jobs", "No se encontraron jobs recientes", "warning");
        }
        
        jobsSpinner.style.display = "none";
        jobsText.textContent = "Ver jobs recientes";
        lastAction.textContent = "Jobs recientes recuperados";
      } catch (e) {
        addLog("‚ùå", "Error al recuperar jobs", e.message, "error");
        showNotification(e.message, true);
        jobsSpinner.style.display = "none";
        jobsText.textContent = "Ver jobs recientes";
      }
    });

    // Abrir docs
    openDocsBtn.addEventListener("click", () => {
      const url = localStorage.getItem("scraperr_api_url") || apiUrlInput.value.trim();
      if (url) {
        window.open(url + "/docs", "_blank");
        addLog("üìñ", "Documentaci√≥n abierta", "API docs en nueva pesta√±a", "info");
        lastAction.textContent = "Documentaci√≥n API abierta";
      } else {
        showNotification("Configura la API Base URL primero", true);
        addLog("‚ùå", "URL API no configurada", "Configura la API Base URL primero", "error");
      }
    });

    // Exportar ZIP
    exportZipBtn.addEventListener("click", async () => {
      if (!lastRawResults) {
        showNotification("No hay resultados para exportar", true);
        addLog("‚ùå", "No hay resultados", "No hay resultados para exportar", "error");
        return;
      }

      try {
        addLog("üì¶", "Exportando resultados", "Creando archivo ZIP", "info");
        const zip = new JSZip();
        zip.file("results.json", JSON.stringify(lastRawResults, null, 2));
        zip.file("preview.json", JSON.stringify(lastPreviewData, null, 2));

        const content = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "scraperr_results.zip";
        a.click();
        
        showNotification("Archivo ZIP descargado");
        addLog("‚úÖ", "ZIP exportado", "Archivo ZIP descargado correctamente", "success");
        lastAction.textContent = "Resultados exportados como ZIP";
      } catch (e) {
        addLog("‚ùå", "Error al exportar ZIP", e.message, "error");
        showNotification("Error al generar el ZIP: " + e.message, true);
      }
    });

    // Limpiar resultados
    clearResultsBtn.addEventListener("click", () => {
      jobResponseEl.textContent = "Esperando que env√≠es un scraping o b√∫squeda OSINT.";
      resultPreviewEl.textContent = "Cuando el job termine, ver√°s ac√° un resumen estructurado.";
      jobMetaEl.textContent = "Todav√≠a no se envi√≥ ning√∫n job.";
      lastRawResults = null;
      lastPreviewData = null;
      showNotification("Resultados limpiados");
      addLog("üßπ", "Resultados limpiados", "√Åreas de respuesta y vista previa limpiadas", "info");
      lastAction.textContent = "Resultados limpiados";
    });

    // AI API Key Functions
    saveApiKeysBtn.addEventListener("click", () => {
      if (geminiKeyInput.value) {
        localStorage.setItem("gemini_api_key", geminiKeyInput.value);
        addLog("ü§ñ", "API Key Gemini guardada", "Clave API de Gemini almacenada", "success");
        showNotification("Gemini API key saved");
      }
      if (openaiKeyInput.value) {
        localStorage.setItem("openai_api_key", openaiKeyInput.value);
        addLog("ü§ñ", "API Key OpenAI guardada", "Clave API de OpenAI almacenada", "success");
        showNotification("OpenAI API key saved");
      }
    });
    
    toggleConfigBtn.addEventListener("click", () => {
      configSection.style.display = configSection.style.display === "block" ? "none" : "block";
      const action = configSection.style.display === "block" ? "abierta" : "cerrada";
      addLog("‚öôÔ∏è", "Configuraci√≥n avanzada", `Secci√≥n de configuraci√≥n ${action}`, "info");
    });
    
    // Actualizar estado de conexi√≥n peri√≥dicamente
    setInterval(async () => {
      if (isScraping) return; // No actualizar mientras se est√° scraping
      
      try {
        const url = localStorage.getItem("scraperr_api_url") || apiUrlInput.value.trim();
        if (url) {
          // Intentar hacer una petici√≥n simple para verificar la conexi√≥n
          await fetch(`${url}/health`, { method: 'GET', cache: 'no-cache' });
          connectionStatus.textContent = "Conectado";
          connectionStatus.className = "badge badge-status";
          connectionStatus.classList.add("success");
        }
      } catch (e) {
        connectionStatus.textContent = "Desconectado";
        connectionStatus.className = "badge badge-status";
        connectionStatus.classList.add("error");
      }
    }, 10000); // Actualizar cada 10 segundos
  </script>
</body>
</html>