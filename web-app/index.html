<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scraperr OSINT PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <!-- JSZip para exportar ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1220;
      --panel: #020617;
      --panel-soft: #0b1220;
      --primary: #0ea5e9;
      --primary-soft: #38bdf8;
      --accent: #22c55e;
      --danger: #f97316;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --radius-xl: 22px;
      --radius: 12px;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.85);
      --font-ui: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-ui);
    }

    body {
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #020617 100%);
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
    }

    .frame {
      max-width: 1280px;
      margin: 0 auto;
      border-radius: 32px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(56,189,248,.4), rgba(129,140,248,.1));
      box-shadow: var(--shadow-soft);
    }

    .container {
      border-radius: 32px;
      background: radial-gradient(circle at top left, #111827 0, #020617 45%, #020617 100%);
      overflow: hidden;
    }

    header {
      padding: 20px 24px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(26px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe 0, #38bdf8 35%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      color: #0b1120;
      box-shadow: 0 8px 22px rgba(15,23,42,.9);
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: .02em;
    }

    .brand-sub {
      font-size: .8rem;
      color: var(--muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: .8rem;
      color: var(--muted);
    }

    .chip-mini {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      backdrop-filter: blur(20px);
      background: rgba(15,23,42,0.7);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34,197,94,.2);
    }

    .main-content {
      display: flex;
      flex-wrap: wrap;
      padding: 16px;
      gap: 16px;
    }

    .left-panel, .right-panel {
      border-radius: 24px;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(30,64,175,0.35);
      backdrop-filter: blur(26px);
      padding: 16px 16px 18px;
    }

    .left-panel {
      flex: 1.3;
      min-width: 340px;
    }

    .right-panel {
      flex: 1.1;
      min-width: 320px;
    }

    h2 {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .section {
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px dashed rgba(55,65,81,0.65);
    }
    .section:last-child { border-bottom: none; }

    .section-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .section-sub {
      font-size: .78rem;
      color: var(--muted);
    }

    .form-group {
      margin-top: 8px;
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: .8rem;
      font-weight: 500;
      margin-bottom: 3px;
      color: #e5e7eb;
    }

    input, textarea, select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(51,65,85,0.9);
      background: radial-gradient(circle at top left, #020617 0, #020617 50%, #020617 100%);
      color: var(--text);
      font-size: .85rem;
      outline: none;
    }

    textarea {
      border-radius: 14px;
      resize: vertical;
      min-height: 80px;
      font-family: monospace;
    }

    input:focus, textarea:focus, select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }

    select {
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
    }

    .small-help {
      font-size: .75rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: .86rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-soft));
      color: #0b1120;
      font-weight: 600;
      box-shadow: 0 10px 24px rgba(8,47,73,0.9);
      transition: transform .1s ease, box-shadow .14s ease, background .14s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(8,47,73,0.95);
      background: linear-gradient(135deg, #38bdf8, #22d3ee);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      box-shadow: 0 10px 24px rgba(5,46,22,0.9);
    }

    .btn-danger {
      background: linear-gradient(135deg, #f97316, #fb7185);
      box-shadow: 0 10px 24px rgba(127,29,29,0.9);
    }

    .inline-group {
      display: flex;
      gap: 8px;
      margin-top: 2px;
    }
    .inline-group > * { flex: 1; }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      font-size: .74rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .chip input {
      width: auto;
      accent-color: var(--primary);
    }

    .toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: .78rem;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: .7rem;
      border: 1px solid rgba(148,163,184,0.4);
      margin-left: 4px;
    }

    .badge-status { color:#fbbf24; border-color: rgba(250,204,21,.5); }

    .notification {
      padding: 7px 9px;
      border-radius: 999px;
      font-size: .78rem;
      margin-bottom: 10px;
      display: none;
    }
    .notification.success {
      display: block;
      background: rgba(22,163,74,.2);
      border: 1px solid rgba(22,163,74,.6);
      color: #bbf7d0;
    }
    .notification.error {
      display: block;
      background: rgba(185,28,28,.2);
      border: 1px solid rgba(220,38,38,.7);
      color: #fecaca;
    }

    .response-box, .result-preview {
      background: radial-gradient(circle at top left,#020617 0,#020617 55%,#020617 100%);
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,1);
      padding: 9px 10px;
      font-family: SFMono-Regular,Menlo,monospace;
      font-size: .78rem;
      max-height: 290px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .job-meta {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: .74rem;
    }

    footer {
      padding: 9px 16px 12px;
      border-top: 1px solid rgba(30,64,175,0.35);
      font-size: .75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    @media (max-width: 900px) {
      .main-content { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="container">
      <header>
        <div class="brand">
          <div class="brand-badge">S</div>
          <div>
            <div class="brand-title">Scraperr OSINT PWA</div>
            <div class="brand-sub">Panel Apple-style para tu Scraperr API</div>
          </div>
        </div>
        <div class="header-right">
          <div class="chip-mini">
            <span class="pill-dot"></span> Online
          </div>
          <span>Backend: <code>scraperr_api</code></span>
        </div>
      </header>

      <div class="main-content">
        <!-- LEFT PANEL -->
        <div class="left-panel">
          <!-- 1. Conexión -->
          <div class="section">
            <div class="section-header-row">
              <h2>1. Conexión</h2>
              <span class="section-sub">API + token (opcional)</span>
            </div>

            <div class="form-group">
              <label for="apiUrl">API Base URL</label>
              <input id="apiUrl" type="text" value="http://localhost:8000" />
              <div class="small-help">
                Ej: <code>http://localhost:8000</code> (scraperr_api).
              </div>
            </div>

            <div class="form-group">
              <label for="apiToken">Access Token (Bearer)</label>
              <input id="apiToken" type="text" placeholder="Pega tu token si usás auth, sino dejá vacío." />
            </div>

            <div class="inline-group">
              <button id="saveConnectionBtn" class="btn btn-secondary">Guardar conexión</button>
              <button id="clearStorageBtn" class="btn btn-danger">Borrar config local</button>
            </div>
            <div class="small-help">
              Se guarda en <code>localStorage</code> (URL, token y cantidad por defecto).
            </div>
          </div>

          <!-- 2. Scraping simple -->
          <div class="section">
            <div class="section-header-row">
              <h2>2. Scraping directo</h2>
              <span class="section-sub">URL + tipos de datos</span>
            </div>

            <div class="form-group">
              <label for="targetUrl">URL objetivo</label>
              <input id="targetUrl" type="text" value="http://quotes.toscrape.com/" />
            </div>

            <div class="form-group">
              <label>Tipo de información</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" class="type-checkbox" value="headings" checked />Headings</label>
                <label class="chip"><input type="checkbox" class="type-checkbox" value="paragraphs" />Párrafos</label>
                <label class="chip"><input type="checkbox" class="type-checkbox" value="links" />Links</label>
                <label class="chip"><input type="checkbox" class="type-checkbox" value="images" />Imágenes</label>
                <label class="chip"><input type="checkbox" class="type-checkbox" value="meta" />Meta</label>
                <label class="chip"><input type="checkbox" class="type-checkbox" value="custom" />Personalizado JSON</label>
              </div>
            </div>

            <div class="form-group">
              <label for="maxItems">Cantidad para vista previa</label>
              <input id="maxItems" type="number" min="1" value="10" />
            </div>

            <div class="form-group">
              <label>Opciones avanzadas</label>
              <div class="toggle-row">
                <label class="toggle"><input type="checkbox" id="multiPage" />Multi-page</label>
                <label class="toggle"><input type="checkbox" id="collectMedia" />Collect media</label>
                <label class="toggle"><input type="checkbox" id="returnHtml" />Return HTML</label>
              </div>
              <div class="inline-group" style="margin-top:6px;">
                <div>
                  <label for="deepDepth">Profundidad</label>
                  <select id="deepDepth">
                    <option value="1">Sólo página actual</option>
                    <option value="2">Seguir paginación básica</option>
                    <option value="3">Exploración más profunda</option>
                  </select>
                </div>
                <div>
                  <label for="deepHint">Hint (opcional)</label>
                  <input id="deepHint" type="text" placeholder="Ej: seguir links 'Siguiente', 'Next'..." />
                </div>
              </div>
              <div class="small-help">
                La profundidad se envía como pista en el campo <code>prompt</code> del Job.
              </div>
            </div>

            <div class="form-group">
              <label for="advancedElements">Elements personalizados (JSON)</label>
              <textarea id="advancedElements" placeholder='[{"name":"Algo","xpath":"//div"}]'></textarea>
            </div>

            <button id="runScrapeBtn" class="btn">Lanzar scraping</button>
          </div>

          <!-- 3. Buscador Universal -->
          <div class="section">
            <div class="section-header-row">
              <h2>3. Buscador Universal OSINT</h2>
              <span class="section-sub">Texto → múltiples servicios</span>
            </div>

            <div class="form-group">
              <label for="universalQuery">Buscar:</label>
              <input id="universalQuery" type="text" placeholder="Ej: nicobattaglia.33" />
            </div>

            <div class="form-group">
              <label>Buscadores / redes</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" class="universal-target" value="google" checked />Google</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="bing" />Bing</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="yandex" />Yandex</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="instagram" />Instagram</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="facebook" />Facebook</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="twitter" />Twitter/X</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="tiktok" />TikTok</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="reddit" />Reddit</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="linkedin" />LinkedIn</label>
              </div>
            </div>

            <div class="form-group">
              <label>Perfiles “especiales” (via Google site:)</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" class="universal-target" value="onlyfans" />OnlyFans</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="badoo" />Badoo</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="skokka" />Skokka</label>
                <label class="chip"><input type="checkbox" class="universal-target" value="tinder" />Tinder</label>
              </div>
            </div>

            <button id="runUniversalSearchBtn" class="btn btn-secondary">
              Buscar en múltiples servicios
            </button>
            <div class="small-help">
              Crea un Job por plataforma, scrapea resultados y arma una vista previa por servicio.
            </div>
          </div>

          <!-- 4. Búsqueda inversa de imagen -->
          <div class="section">
            <div class="section-header-row">
              <h2>4. Búsqueda inversa de imagen</h2>
              <span class="section-sub">OSINT por imagen</span>
            </div>

            <div class="form-group">
              <label for="imageUrl">URL de la imagen</label>
              <input id="imageUrl" type="text" placeholder="Pega la URL directa de una imagen" />
            </div>

            <div class="form-group">
              <label>Servicios de imagen</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" class="image-target" value="google" checked />Google</label>
                <label class="chip"><input type="checkbox" class="image-target" value="yandex" />Yandex</label>
                <label class="chip"><input type="checkbox" class="image-target" value="bing" />Bing</label>
              </div>
            </div>

            <div class="inline-group">
              <button id="runImageSearchBtn" class="btn btn-secondary">Buscar por imagen (scraping)</button>
              <button id="openImageTabsBtn" class="btn">Abrir pestañas</button>
            </div>
            <div class="small-help">
              “Buscar por imagen” genera jobs sobre las páginas de resultados; “Abrir pestañas” sólo abre los buscadores con esa imagen.
            </div>
          </div>

          <!-- 5. Otros accesos -->
          <div class="section">
            <h2>5. Jobs & Docs rápidos</h2>
            <div class="inline-group">
              <button id="listJobsBtn" class="btn btn-secondary">Ver jobs recientes</button>
              <button id="openDocsBtn" class="btn btn-secondary">Abrir Swagger /docs</button>
            </div>
          </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel">
          <div id="notification" class="notification"></div>

          <div class="section">
            <div class="section-header-row">
              <h2>Estado / respuesta</h2>
              <span class="section-sub">Job actual / OSINT multi-servicio</span>
            </div>
            <div class="tag-row">
              <span class="badge badge-status" id="statusBadge">Idle</span>
              <span class="badge">Vista previa limitada a <span id="badgeMaxItems">10</span> ítems</span>
            </div>
            <div class="job-meta" id="jobMeta">
              Todavía no se envió ningún job.
            </div>
            <div class="response-box" id="jobResponse">
              Esperando que envíes un scraping o búsqueda OSINT.
            </div>
          </div>

          <div class="section">
            <div class="section-header-row">
              <h2>Vista previa / resumen</h2>
              <span class="section-sub">Recorte de datos para inspección rápida</span>
            </div>
            <div class="result-preview" id="resultPreview">
              Cuando el job termine, verás acá un resumen estructurado.
            </div>
          </div>

          <div class="section">
            <div class="section-header-row">
              <h2>Exportar</h2>
              <span class="section-sub">JSON / CSV dentro de un ZIP</span>
            </div>
            <button id="exportZipBtn" class="btn">Exportar último resultado como ZIP</button>
            <div class="small-help">
              Incluye: <code>results_full.json</code>, <code>preview.json</code> y <code>flat.csv</code> (si es posible aplanar).
            </div>
          </div>
        </div>
      </div>

      <footer>
        <span>Scraperr OSINT PWA • Cliente avanzado sobre tu backend <code>scraperr_api</code></span>
        <span>Listo para instalar como app en escritorio o móvil.</span>
      </footer>
    </div>
  </div>

  <script>
    // Storage keys
    const STORAGE_KEYS = {
      baseUrl: "scraperr_api_url",
      token: "scraperr_api_token",
      maxItems: "scraperr_max_items",
    };

    // DOM
    const apiUrlInput = document.getElementById("apiUrl");
    const apiTokenInput = document.getElementById("apiToken");
    const saveConnectionBtn = document.getElementById("saveConnectionBtn");
    const clearStorageBtn = document.getElementById("clearStorageBtn");
    const targetUrlInput = document.getElementById("targetUrl");
    const typeCheckboxes = document.querySelectorAll(".type-checkbox");
    const maxItemsInput = document.getElementById("maxItems");
    const multiPageCheckbox = document.getElementById("multiPage");
    const collectMediaCheckbox = document.getElementById("collectMedia");
    const returnHtmlCheckbox = document.getElementById("returnHtml");
    const deepDepthSelect = document.getElementById("deepDepth");
    const deepHintInput = document.getElementById("deepHint");
    const advancedElementsTextarea = document.getElementById("advancedElements");
    const runScrapeBtn = document.getElementById("runScrapeBtn");
    const universalQueryInput = document.getElementById("universalQuery");
    const runUniversalSearchBtn = document.getElementById("runUniversalSearchBtn");
    const imageUrlInput = document.getElementById("imageUrl");
    const runImageSearchBtn = document.getElementById("runImageSearchBtn");
    const openImageTabsBtn = document.getElementById("openImageTabsBtn");
    const listJobsBtn = document.getElementById("listJobsBtn");
    const openDocsBtn = document.getElementById("openDocsBtn");
    const notificationEl = document.getElementById("notification");
    const jobMetaEl = document.getElementById("jobMeta");
    const jobResponseEl = document.getElementById("jobResponse");
    const resultPreviewEl = document.getElementById("resultPreview");
    const statusBadge = document.getElementById("statusBadge");
    const badgeMaxItems = document.getElementById("badgeMaxItems");
    const exportZipBtn = document.getElementById("exportZipBtn");

    // XPaths base
    const SCRAPE_TEMPLATES = {
      headings: [{ name: "Headings", xpath: "//h1 | //h2 | //h3" }],
      paragraphs: [{ name: "Paragraphs", xpath: "//p" }],
      links: [{ name: "Links", xpath: "//a/@href" }],
      images: [{ name: "Images", xpath: "//img/@src" }],
      meta: [
        { name: "Title", xpath: "//title" },
        { name: "MetaDescription", xpath: "//meta[@name='description']/@content" },
      ],
    };

    // URLs de búsqueda de texto
    const UNIVERSAL_SEARCH_URLS = {
      google: q => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
      bing: q => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
      yandex: q => `https://yandex.com/search/?text=${encodeURIComponent(q)}`,
      instagram: q => `https://www.instagram.com/${q}`,
      facebook: q => `https://www.facebook.com/public/${encodeURIComponent(q)}`,
      twitter: q => `https://x.com/search?q=${encodeURIComponent(q)}`,
      tiktok: q => `https://www.tiktok.com/search?q=${encodeURIComponent(q)}`,
      reddit: q => `https://www.reddit.com/search/?q=${encodeURIComponent(q)}`,
      linkedin: q => `https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(q)}`,

      // Perfiles especiales via Google site:
      onlyfans: q => `https://www.google.com/search?q=${encodeURIComponent(q + " site:onlyfans.com")}`,
      badoo: q => `https://www.google.com/search?q=${encodeURIComponent(q + " site:badoo.com")}`,
      skokka: q => `https://www.google.com/search?q=${encodeURIComponent(q + " site:skokka.com")}`,
      tinder: q => `https://www.google.com/search?q=${encodeURIComponent(q + " site:tinder.com")}`,
    };

    // URLs de búsqueda inversa por imagen (solo URLs; algunos servicios pueden cambiar formato)
    const IMAGE_SEARCH_URLS = {
      google: img => `https://www.google.com/searchbyimage?image_url=${encodeURIComponent(img)}`,
      yandex: img => `https://yandex.com/images/search?rpt=imageview&url=${encodeURIComponent(img)}`,
      bing: img => `https://www.bing.com/images/search?view=detailv2&iss=sbi&form=SBIIRP&sbisrc=UrlPaste&q=imgurl:${encodeURIComponent(img)}`,
    };

    // Estado para exportación
    let lastRawResults = null;
    let lastPreviewData = null;

    function showNotification(msg, isError = false) {
      if (!msg) {
        notificationEl.className = "notification";
        notificationEl.textContent = "";
        return;
      }
      notificationEl.textContent = msg;
      notificationEl.className = "notification " + (isError ? "error" : "success");
    }

    function setStatus(text) {
      statusBadge.textContent = text;
    }

    function loadFromStorage() {
      const savedUrl = localStorage.getItem(STORAGE_KEYS.baseUrl);
      const savedToken = localStorage.getItem(STORAGE_KEYS.token);
      const savedMaxItems = localStorage.getItem(STORAGE_KEYS.maxItems);

      if (savedUrl) apiUrlInput.value = savedUrl;
      if (savedToken) apiTokenInput.value = savedToken;
      if (savedMaxItems) {
        maxItemsInput.value = savedMaxItems;
        badgeMaxItems.textContent = savedMaxItems;
      }
    }

    function saveConnection() {
      localStorage.setItem(STORAGE_KEYS.baseUrl, apiUrlInput.value.trim());
      localStorage.setItem(STORAGE_KEYS.token, apiTokenInput.value.trim());
      localStorage.setItem(STORAGE_KEYS.maxItems, maxItemsInput.value.trim() || "10");
      badgeMaxItems.textContent = maxItemsInput.value.trim() || "10";
      showNotification("Conexión guardada en localStorage");
    }

    saveConnectionBtn.addEventListener("click", saveConnection);

    clearStorageBtn.addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEYS.baseUrl);
      localStorage.removeItem(STORAGE_KEYS.token);
      localStorage.removeItem(STORAGE_KEYS.maxItems);
      showNotification("Configuración local borrada");
    });

    maxItemsInput.addEventListener("change", () => {
      badgeMaxItems.textContent = maxItemsInput.value || "10";
    });

    // Llamada genérica a API
    async function callApi(path, method = "GET", body = null) {
      const baseUrl = apiUrlInput.value.trim().replace(/\/+$/, "");
      if (!baseUrl) {
        showNotification("Configura primero la API Base URL", true);
        throw new Error("API URL vacía");
      }
      const url = `${baseUrl}${path}`;
      const headers = { "Content-Type": "application/json" };
      const token = apiTokenInput.value.trim();
      if (token) headers["Authorization"] = `Bearer ${token}`;

      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const resp = await fetch(url, options);
      let json;
      try {
        json = await resp.json();
      } catch (e) {
        json = { raw: await resp.text() };
      }
      if (!resp.ok) {
        const msg = `Error ${resp.status}: ${JSON.stringify(json)}`;
        showNotification(msg, true);
      }
      return { status: resp.status, data: json };
    }

    function buildElementsFromSelection() {
      const selected = Array.from(typeCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      const useCustom = selected.includes("custom");
      let elements = [];

      if (useCustom) {
        const txt = advancedElementsTextarea.value.trim();
        if (!txt) throw new Error("Marcaste 'Personalizado' pero el JSON está vacío.");
        try {
          const parsed = JSON.parse(txt);
          if (!Array.isArray(parsed)) throw new Error("El JSON debe ser un array de elementos.");
          elements = parsed;
        } catch (e) {
          throw new Error("Error parseando Elements personalizados: " + e.message);
        }
      } else {
        selected.forEach(type => {
          if (SCRAPE_TEMPLATES[type]) {
            SCRAPE_TEMPLATES[type].forEach(t => {
              elements.push({ name: t.name, xpath: t.xpath, url: null });
            });
          }
        });
      }

      if (elements.length === 0) throw new Error("Elegí al menos un tipo de información.");

      const url = targetUrlInput.value.trim();
      elements = elements.map(el => ({ ...el, url: el.url !== undefined ? el.url : url }));
      return elements;
    }

    function buildJobOptions() {
      return {
        multi_page_scrape: multiPageCheckbox.checked,
        custom_headers: {},
        proxies: [],
        site_map: null,
        collect_media: collectMediaCheckbox.checked,
        custom_cookies: [],
        return_html: returnHtmlCheckbox.checked,
      };
    }

    function sliceResultForPreview(result, maxItems) {
      if (!result) return result;
      const limit = Number(maxItems) || 10;

      if (Array.isArray(result)) return result.slice(0, limit);

      if (typeof result === "object") {
        const out = {};
        for (const key of Object.keys(result)) {
          const val = result[key];
          if (Array.isArray(val)) out[key] = val.slice(0, limit);
          else out[key] = val;
        }
        return out;
      }

      return result;
    }

    async function waitForJobCompletion(jobId, maxWaitMs = 35000, intervalMs = 3000) {
      const start = Date.now();
      let lastData = null;

      while (Date.now() - start < maxWaitMs) {
        const { data } = await callApi(`/api/job/${encodeURIComponent(jobId)}`, "GET");
        lastData = data;

        const status = (data.status || data.Status || "").toString();
        jobMetaEl.textContent = `Job ${jobId} – Estado: ${status}`;
        jobResponseEl.textContent = JSON.stringify(data, null, 2);
        setStatus(status || "Unknown");

        if (status.toLowerCase() === "completed" || status.toLowerCase() === "failed") {
          return data;
        }
        await new Promise(res => setTimeout(res, intervalMs));
      }
      return lastData;
    }

    // Scraping directo
    runScrapeBtn.addEventListener("click", async () => {
      try {
        showNotification("Enviando job de scraping...");
        setStatus("Working…");

        const url = targetUrlInput.value.trim();
        if (!url) {
          showNotification("La URL objetivo no puede estar vacía", true);
          setStatus("Error");
          return;
        }

        const elements = buildElementsFromSelection();
        const jobOptions = buildJobOptions();
        const depth = deepDepthSelect.value;
        const hint = deepHintInput.value.trim();

        const jobBody = {
          url,
          elements,
          job_options: jobOptions,
          prompt: `Profundidad deseada: ${depth}. Hint: ${hint || "sin hint"}`,
        };

        const submit = await callApi("/api/submit-scrape-job", "POST", jobBody);
        jobResponseEl.textContent = JSON.stringify(submit.data, null, 2);

        if (!submit.data || !submit.data.id) {
          showNotification("Job enviado, pero sin ID en la respuesta.", true);
          setStatus("Error");
          return;
        }

        const jobId = submit.data.id;
        jobMetaEl.textContent = `Job enviado. ID: ${jobId}. Esperando resultado...`;
        showNotification(`Job ${jobId} enviado; consultando estado...`);

        const jobData = await waitForJobCompletion(jobId);
        const maxItems = maxItemsInput.value || "10";

        const preview = sliceResultForPreview(jobData?.result || jobData?.Result || jobData, maxItems);
        resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

        lastRawResults = jobData;
        lastPreviewData = preview;

        showNotification("Job completado. Mirá la vista previa y, si querés, exportá el ZIP.");
      } catch (e) {
        showNotification(e.message, true);
        setStatus("Error");
      }
    });

    // Universal search
    async function runUniversalSearch() {
      const query = universalQueryInput.value.trim();
      const platforms = Array.from(document.querySelectorAll(".universal-target"))
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      if (!query) {
        showNotification("Escribí qué querés buscar.", true);
        return;
      }
      if (platforms.length === 0) {
        showNotification("Seleccioná al menos una plataforma.", true);
        return;
      }

      showNotification("Generando y enviando jobs OSINT...");
      setStatus("OSINT…");

      const jobs = [];
      for (const platform of platforms) {
        const url = UNIVERSAL_SEARCH_URLS[platform](query);
        const job = {
          url,
          elements: [
            { name: "Links", xpath: "//a/@href", url: null },
            { name: "Titles", xpath: "//title", url: null },
            { name: "Text", xpath: "//body//text()", url: null },
          ],
          job_options: {
            multi_page_scrape: false,
            collect_media: false,
            custom_headers: {},
            proxies: [],
            custom_cookies: [],
            site_map: null,
            return_html: false,
          },
          prompt: `OSINT para query="${query}" en plataforma=${platform}`,
        };

        const response = await callApi("/api/submit-scrape-job", "POST", job);
        if (response.data.id) {
          jobs.push({ platform, jobId: response.data.id });
        }
      }

      const results = {};
      for (const job of jobs) {
        const data = await waitForJobCompletion(job.jobId);
        results[job.platform] = data.result || data;
      }

      const preview = {};
      const maxItems = maxItemsInput.value || "10";

      for (const [platform, data] of Object.entries(results)) {
        const titles = data?.Titles || data?.titles || [];
        const links = data?.Links || data?.links || [];
        const text = data?.Text || data?.text || [];

        preview[platform] = {
          title: titles[0] || "",
          first_links: (links || []).slice(0, maxItems),
          first_text: (text || []).slice(0, maxItems),
        };
      }

      jobMetaEl.textContent = "Resultados OSINT multi-plataforma (respuesta completa abajo).";
      jobResponseEl.textContent = JSON.stringify(results, null, 2);
      resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

      lastRawResults = results;
      lastPreviewData = preview;

      showNotification("Búsqueda universal completada.");
      setStatus("OK");
    }

    runUniversalSearchBtn.addEventListener("click", runUniversalSearch);

    // Imagen inversa (scraping)
    async function runImageSearch(scrape = true) {
      const imgUrl = imageUrlInput.value.trim();
      const targets = Array.from(document.querySelectorAll(".image-target"))
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      if (!imgUrl) {
        showNotification("Pegá primero la URL de la imagen.", true);
        return;
      }
      if (targets.length === 0) {
        showNotification("Elegí al menos un servicio de imagen.", true);
        return;
      }

      if (!scrape) {
        // Sólo pestañas
        targets.forEach(t => {
          const url = IMAGE_SEARCH_URLS[t](imgUrl);
          window.open(url, "_blank");
        });
        showNotification("Abrí pestañas con los buscadores de imágenes.");
        return;
      }

      // Scraping
      showNotification("Enviando jobs de búsqueda inversa...");
      setStatus("Img OSINT…");

      const jobs = [];
      for (const t of targets) {
        const url = IMAGE_SEARCH_URLS[t](imgUrl);
        const job = {
          url,
          elements: [
            { name: "Links", xpath: "//a/@href", url: null },
            { name: "Titles", xpath: "//title", url: null },
            { name: "Text", xpath: "//body//text()", url: null },
          ],
          job_options: {
            multi_page_scrape: false,
            collect_media: false,
            custom_headers: {},
            proxies: [],
            custom_cookies: [],
            site_map: null,
            return_html: false,
          },
          prompt: `OSINT por imagen URL=${imgUrl} en servicio=${t}`,
        };
        const resp = await callApi("/api/submit-scrape-job", "POST", job);
        if (resp.data.id) jobs.push({ service: t, jobId: resp.data.id });
      }

      const results = {};
      for (const job of jobs) {
        const data = await waitForJobCompletion(job.jobId);
        results[job.service] = data.result || data;
      }

      const preview = {};
      const maxItems = maxItemsInput.value || "10";

      for (const [service, data] of Object.entries(results)) {
        const titles = data?.Titles || data?.titles || [];
        const links = data?.Links || data?.links || [];
        preview[service] = {
          title: titles[0] || "",
          first_links: (links || []).slice(0, maxItems),
        };
      }

      jobMetaEl.textContent = "Resultados de búsqueda inversa por imagen.";
      jobResponseEl.textContent = JSON.stringify(results, null, 2);
      resultPreviewEl.textContent = JSON.stringify(preview, null, 2);

      lastRawResults = results;
      lastPreviewData = preview;

      showNotification("Búsqueda inversa de imagen completada.");
      setStatus("OK");
    }

    runImageSearchBtn.addEventListener("click", () => runImageSearch(true));
    openImageTabsBtn.addEventListener("click", () => runImageSearch(false));

    // Jobs recientes
    listJobsBtn.addEventListener("click", async () => {
      try {
        const { data } = await callApi("/api/retrieve-scrape-jobs", "POST", { chat: null });
        jobMetaEl.textContent = "Jobs recientes (respuesta cruda de la API):";
        jobResponseEl.textContent = JSON.stringify(data, null, 2);
        showNotification("Jobs recuperados.");
      } catch (e) {
        showNotification(e.message, true);
      }
    });

    // Docs
    openDocsBtn.addEventListener("click", () => {
      const baseUrl = apiUrlInput.value.trim().replace(/\/+$/, "");
      if (!baseUrl) {
        showNotification("Configura primero la API Base URL", true);
        return;
      }
      window.open(`${baseUrl}/docs`, "_blank");
    });

    // Export ZIP
    function flattenForCsv(data) {
      if (!data) return [];
      if (Array.isArray(data)) {
        // Si son strings, las metemos como columna "value"
        if (data.every(v => typeof v === "string" || typeof v === "number")) {
          return data.map(v => ({ value: v }));
        }
        if (data.every(v => typeof v === "object")) return data;
        return [];
      }
      if (typeof data === "object") {
        // Si es mapa {key: array} -> convertimos a filas key/value
        const rows = [];
        for (const [k, v] of Object.entries(data)) {
          if (Array.isArray(v)) {
            v.forEach(item => {
              rows.push({ key: k, value: item });
            });
          } else {
            rows.push({ key: k, value: v });
          }
        }
        return rows;
      }
      return [];
    }

    function toCsv(rows) {
      if (!rows || rows.length === 0) return "";
      const headers = Array.from(
        rows.reduce((set, row) => {
          Object.keys(row).forEach(k => set.add(k));
          return set;
        }, new Set())
      );
      const escape = value => {
        if (value === null || value === undefined) return "";
        const str = String(value);
        if (str.includes('"') || str.includes(",") || str.includes("\n")) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      };
      const lines = [];
      lines.push(headers.join(","));
      for (const row of rows) {
        lines.push(headers.map(h => escape(row[h])).join(","));
      }
      return lines.join("\n");
    }

    exportZipBtn.addEventListener("click", () => {
      if (!lastRawResults && !lastPreviewData) {
        showNotification("Todavía no hay datos para exportar.", true);
        return;
      }
      const zip = new JSZip();
      if (lastRawResults) {
        zip.file("results_full.json", JSON.stringify(lastRawResults, null, 2));
      }
      if (lastPreviewData) {
        zip.file("preview.json", JSON.stringify(lastPreviewData, null, 2));
        const flatRows = flattenForCsv(lastPreviewData);
        if (flatRows.length > 0) {
          zip.file("flat.csv", toCsv(flatRows));
        }
      }
      zip.generateAsync({ type: "blob" }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "scraperr_results.zip";
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      });
      showNotification("ZIP generado y descargado.");
    });

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      loadFromStorage();
      if ("serviceWorker" in navigator && window.location.protocol !== "file:") {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch(err => console.log("SW registration failed:", err));
      }
      setStatus("Idle");
    });
  </script>
</body>
</html>
